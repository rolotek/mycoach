---
phase: 04-agent-evolution
plan: "02"
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/server/src/agents/prompt-evolver.ts
  - apps/server/src/trpc/router.ts
autonomous: true

must_haves:
  truths:
    - "Feedback can be submitted via tRPC and stored in the database"
    - "Agent version history is saved before any prompt change"
    - "Prompt evolution triggers automatically when feedback threshold is met (3+ items with actionable signal)"
    - "Agent can be archived and unarchived via tRPC"
    - "Agent versions can be listed and reverted via tRPC"
  artifacts:
    - path: "apps/server/src/agents/prompt-evolver.ts"
      provides: "Meta-prompting pipeline for prompt evolution"
      exports: ["evolveAgentPrompt", "checkAndEvolveAgent"]
    - path: "apps/server/src/trpc/router.ts"
      provides: "agentFeedback and agentVersion tRPC procedures, archive/unarchive on agent router"
      contains: "agentFeedback"
  key_links:
    - from: "apps/server/src/trpc/router.ts"
      to: "apps/server/src/agents/prompt-evolver.ts"
      via: "fire-and-forget call on feedback create"
      pattern: "checkAndEvolveAgent"
    - from: "apps/server/src/agents/prompt-evolver.ts"
      to: "apps/server/src/db/schema.ts"
      via: "reads agentFeedback + agentExecutions, writes agentVersions + agents"
      pattern: "agentFeedback|agentVersions|agents"
    - from: "apps/server/src/trpc/router.ts"
      to: "apps/server/src/db/schema.ts"
      via: "agent.update saves version before changing prompt"
      pattern: "saveAgentVersion"
---

<objective>
Build the feedback collection API, prompt evolution pipeline, and agent versioning/archive tRPC procedures.

Purpose: This is the core backend logic for Phase 4 -- collecting user feedback on agent outputs, automatically evolving agent prompts based on accumulated feedback patterns, and managing agent versions with archive lifecycle.
Output: prompt-evolver.ts (meta-prompting pipeline), extended tRPC router with feedback, version, and archive procedures.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-agent-evolution/04-RESEARCH.md
@.planning/phases/04-agent-evolution/04-01-SUMMARY.md
@apps/server/src/db/schema.ts
@apps/server/src/trpc/router.ts
@apps/server/src/memory/fact-extractor.ts
@apps/server/src/agents/agent-executor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create prompt-evolver.ts meta-prompting pipeline</name>
  <files>apps/server/src/agents/prompt-evolver.ts</files>
  <action>
Create `apps/server/src/agents/prompt-evolver.ts` with two exported functions:

**1. `evolveAgentPrompt` function:**
- Accepts: `agentId: string`, `currentPrompt: string`, `feedback: Array<{ rating: string; correction: string | null; task: string; result: string }>`, `modelId: string`
- Returns: `Promise<{ revisedPrompt: string; changesSummary: string; reasoning: string } | null>`
- Uses `generateText` from "ai" with `Output.object({ schema: revisionSchema })` -- exact same pattern as `fact-extractor.ts`
- Define `revisionSchema` with zod: `{ revisedPrompt: z.string(), changesSummary: z.string(), reasoning: z.string() }`
- System prompt (META_PROMPT): instruct the LLM to act as a prompt engineer, preserve agent core identity, incorporate positive feedback patterns, address negative feedback, apply user corrections, keep prompt concise. Include rules: "Do NOT add capabilities the original prompt didn't have", "Do NOT remove core instructions unless feedback specifically contradicts them"
- User prompt: include the current system prompt and formatted feedback (each with rating, task excerpt truncated to 500 chars, result excerpt truncated to 500 chars, correction if present)
- If feedback.length < 3, return null immediately (threshold not met)
- Model: use `getModel(modelId)` from `../llm/providers`

**2. `checkAndEvolveAgent` function:**
- Accepts: `agentId: string`, `userId: string`
- Returns: `Promise<void>`
- Steps:
  a. Fetch the agent from DB (verify ownership via userId)
  b. Find last evolution version from agentVersions where changeSource = "evolution", ordered by createdAt desc, limit 1
  c. Fetch feedback since last evolution (or all feedback if no prior evolution) by comparing createdAt
  d. Check threshold: need 3+ feedback items AND at least 1 negative rating or 1 with non-null correction. If not met, return early.
  e. Check cooldown: if last evolution was less than 1 hour ago, return early (compare lastEvolution.createdAt to Date.now())
  f. Enrich feedback with execution context: for each feedback item with an executionId, join with agentExecutions to get task and result
  g. Determine model: use `process.env.PROMPT_EVOLUTION_MODEL ?? process.env.COACH_FACT_MODEL ?? "ollama:llama3.1"`
  h. Call `evolveAgentPrompt` with current prompt and enriched feedback
  i. If revision returned: save current prompt as new version via `saveAgentVersion` (see below), then update agent's systemPrompt and updatedAt
  j. Wrap everything in try/catch, log errors with console.error (fire-and-forget, must not throw)

**3. `saveAgentVersion` helper (exported):**
- Accepts: db instance, agentId, currentSystemPrompt, changeSource ("manual" | "evolution" | "initial"), changeSummary (string | null)
- Queries MAX(version) from agentVersions for this agentId, sets nextVersion = max + 1 (or 1 if none)
- Inserts new row into agentVersions with agentId, version: nextVersion, systemPrompt: currentSystemPrompt, changeSource, changeSummary

Import db from "../db", schema tables from "../db/schema", getModel from "../llm/providers". Use eq, and, desc, gt, isNull from "drizzle-orm".
  </action>
  <verify>
Run `npx tsc --noEmit -p apps/server/tsconfig.json` to verify TypeScript compiles. Check that the file exports evolveAgentPrompt, checkAndEvolveAgent, and saveAgentVersion.
  </verify>
  <done>prompt-evolver.ts exists with evolveAgentPrompt (meta-prompting via generateText + Output.object), checkAndEvolveAgent (threshold + cooldown + enrichment + evolution), and saveAgentVersion (version incrementing + insert). All compile cleanly.</done>
</task>

<task type="auto">
  <name>Task 2: Add feedback, version, and archive tRPC procedures</name>
  <files>apps/server/src/trpc/router.ts</files>
  <action>
Extend `apps/server/src/trpc/router.ts` with new sub-routers and modifications:

**1. Import new schema tables and prompt-evolver:**
- Add `agentFeedback, agentVersions` to the schema import
- Add `import { checkAndEvolveAgent, saveAgentVersion } from "../agents/prompt-evolver";`
- Add `isNull` to the drizzle-orm import (alongside existing eq, and, desc, asc, sql)

**2. Add `agentFeedbackRouter`:**
- `create`: protectedProcedure, input `{ agentId: z.string().uuid(), executionId: z.string().uuid().optional(), rating: z.enum(["positive", "negative"]), correction: z.string().max(1000).optional() }`. Insert into agentFeedback with userId from ctx. After insert, fire-and-forget: `checkAndEvolveAgent(input.agentId, ctx.user.id).catch(err => console.error("Evolution check failed:", err))`. Return the inserted row.
- `listByAgent`: protectedProcedure, input `{ agentId: z.string().uuid() }`. Select from agentFeedback where agentId matches AND userId matches. Order by createdAt desc.

**3. Add `agentVersionRouter`:**
- `list`: protectedProcedure, input `{ agentId: z.string().uuid() }`. Verify agent belongs to user (select from agents where id = input.agentId AND userId = ctx.user.id, throw NOT_FOUND if missing). Then select from agentVersions where agentId matches, order by version desc, limit 20. Return rows.
- `revert`: protectedProcedure, input `{ agentId: z.string().uuid(), versionId: z.string().uuid() }`. Verify agent ownership. Fetch target version from agentVersions by versionId. If not found, throw NOT_FOUND. Call `saveAgentVersion(ctx.db, input.agentId, agent.systemPrompt, "manual", "Reverted to version " + targetVersion.version)` to save current prompt. Then update agents set systemPrompt = targetVersion.systemPrompt, updatedAt = new Date() where id = input.agentId. Return updated agent.

**4. Modify existing `agentRouter`:**
- **agent.update mutation:** Before updating the agent's systemPrompt (only when input.systemPrompt is provided AND differs from current), call `saveAgentVersion(ctx.db, input.id, existingAgent.systemPrompt, "manual", null)`. This requires first fetching the existing agent to compare. Add a select query at the start of the mutation to get the current agent, then proceed with the update. This ensures every manual prompt edit creates a version snapshot.
- **agent.list query:** Add filtering to exclude archived agents by default. Change the where clause to: `and(eq(agents.userId, ctx.user.id), isNull(agents.archivedAt))`. Keep the orderBy as-is.
- **Add `agent.listAll` query:** Same as list but WITHOUT the archivedAt filter -- returns all agents including archived. Used by the management page. Order by: `asc(agents.archivedAt)` then `asc(agents.name)` (active first, then archived).
- **Add `agent.archive` mutation:** protectedProcedure, input `{ id: z.string().uuid() }`. Update agents set archivedAt = new Date() where id = input.id AND userId = ctx.user.id AND archivedAt IS NULL. Return { success: true }.
- **Add `agent.unarchive` mutation:** protectedProcedure, input `{ id: z.string().uuid() }`. Update agents set archivedAt = null where id = input.id AND userId = ctx.user.id. Return { success: true }.

**5. Register new routers in appRouter:**
- Add `agentFeedback: agentFeedbackRouter` and `agentVersion: agentVersionRouter` to the appRouter.

Follow existing tRPC patterns exactly (protectedProcedure, ctx.db, TRPCError codes, .returning() where needed).
  </action>
  <verify>
Run `npx tsc --noEmit -p apps/server/tsconfig.json` to verify TypeScript compiles. Verify the appRouter includes agentFeedback and agentVersion. Check that agent.list filters archivedAt and agent.listAll does not.
  </verify>
  <done>tRPC router has agentFeedbackRouter (create, listByAgent), agentVersionRouter (list, revert), and agent router extended with listAll, archive, unarchive. agent.update saves version before prompt changes. agent.list excludes archived. All compile cleanly.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit -p apps/server/tsconfig.json` passes
2. prompt-evolver.ts exports: evolveAgentPrompt, checkAndEvolveAgent, saveAgentVersion
3. tRPC appRouter includes: agentFeedback, agentVersion sub-routers
4. agent.list filters archived, agent.listAll does not
5. agent.update saves version snapshot before prompt changes
6. Feedback create triggers fire-and-forget evolution check
</verification>

<success_criteria>
- Feedback can be submitted via agentFeedback.create tRPC mutation
- Version history saved automatically on agent.update (when prompt changes) and on evolution
- checkAndEvolveAgent respects 3+ threshold, actionable signal requirement, and 1-hour cooldown
- Agents can be archived/unarchived via tRPC mutations
- Version list and revert work correctly with ownership checks
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-agent-evolution/04-02-SUMMARY.md`
</output>
