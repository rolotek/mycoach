---
phase: 04-agent-evolution
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/server/src/db/schema.ts
  - apps/server/src/coaching/chat-route.ts
autonomous: true

must_haves:
  truths:
    - "agentFeedback and agentVersions tables exist in the database"
    - "agents table has an archivedAt column for soft-delete"
    - "Archived agents are excluded from chief-of-staff dispatch tools"
  artifacts:
    - path: "apps/server/src/db/schema.ts"
      provides: "agentFeedback, agentVersions tables + archivedAt on agents"
      contains: "agentFeedback"
    - path: "apps/server/src/coaching/chat-route.ts"
      provides: "Archive-aware agent query for chief-of-staff"
      contains: "isNull"
  key_links:
    - from: "apps/server/src/coaching/chat-route.ts"
      to: "apps/server/src/db/schema.ts"
      via: "agents query with archivedAt filter"
      pattern: "isNull.*archivedAt"
---

<objective>
Add the database schema for feedback collection, agent versioning, and soft-delete archiving. Update the chat route to exclude archived agents from dispatch.

Purpose: Creates the data foundation for all Phase 4 features -- feedback storage, version history, and archive lifecycle.
Output: Two new DB tables (agentFeedback, agentVersions), archivedAt column on agents, archive-filtered agent query in chat route.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-agent-evolution/04-RESEARCH.md
@apps/server/src/db/schema.ts
@apps/server/src/coaching/chat-route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add agentFeedback, agentVersions tables and archivedAt column</name>
  <files>apps/server/src/db/schema.ts</files>
  <action>
Add three schema changes to `apps/server/src/db/schema.ts`:

1. **Add `archivedAt` column to the existing `agents` table definition:**
   - `archivedAt: timestamp("archived_at")` -- nullable, null means active, set means archived.
   - Place it after the `updatedAt` column in the existing agents table.

2. **Add `agentFeedback` table** after the `agentExecutions` table:
   - `id`: uuid, primaryKey, defaultRandom
   - `userId`: text, notNull, references user.id with onDelete cascade
   - `agentId`: uuid, notNull, references agents.id with onDelete cascade
   - `executionId`: uuid, nullable, references agentExecutions.id with onDelete "set null"
   - `rating`: text, notNull (values: "positive" | "negative")
   - `correction`: text, nullable (optional text feedback from user)
   - `createdAt`: timestamp, defaultNow, notNull
   - Indexes: `agent_feedback_agentId_idx` on agentId, `agent_feedback_userId_idx` on userId

3. **Add `agentVersions` table** after agentFeedback:
   - `id`: uuid, primaryKey, defaultRandom
   - `agentId`: uuid, notNull, references agents.id with onDelete cascade
   - `version`: integer, notNull
   - `systemPrompt`: text, notNull
   - `changeSource`: text, notNull (values: "manual" | "evolution" | "initial")
   - `changeSummary`: text, nullable
   - `createdAt`: timestamp, defaultNow, notNull
   - Indexes: `agent_versions_agentId_idx` on agentId
   - Unique constraint: `agent_versions_agentId_version_unique` on (agentId, version)

4. **Add relations** for both new tables:
   - `agentFeedbackRelations`: one-to-one with user (userId -> user.id), one-to-one with agent (agentId -> agents.id), one-to-one with agentExecution (executionId -> agentExecutions.id)
   - `agentVersionRelations`: one-to-one with agent (agentId -> agents.id)

5. **Update `agentRelations`** to add `many(agentFeedback)` and `many(agentVersions)`.

6. **Run `npx drizzle-kit push`** to apply the schema changes to the database.

Follow the exact patterns used by existing tables (uuid IDs, timestamp conventions, index naming, relation patterns). See the research code examples for exact column definitions.
  </action>
  <verify>
Run `npx drizzle-kit push` successfully. Then verify with: `npx tsx -e "import { agentFeedback, agentVersions, agents } from './apps/server/src/db/schema'; console.log('agentFeedback columns:', Object.keys(agentFeedback)); console.log('agentVersions columns:', Object.keys(agentVersions)); console.log('agents has archivedAt:', 'archivedAt' in agents);"` -- should print column names for both tables and true for archivedAt.
  </verify>
  <done>agentFeedback and agentVersions tables exist in schema.ts with correct columns, indexes, and relations. archivedAt column exists on agents table. Schema pushed to database successfully.</done>
</task>

<task type="auto">
  <name>Task 2: Filter archived agents from chief-of-staff dispatch</name>
  <files>apps/server/src/coaching/chat-route.ts</files>
  <action>
In `apps/server/src/coaching/chat-route.ts`, update the agent query (currently line ~91-94) that fetches agents for the chief-of-staff:

**Current code:**
```typescript
const userAgents = await db
  .select()
  .from(agents)
  .where(eq(agents.userId, user.id));
```

**Change to:**
```typescript
const userAgents = await db
  .select()
  .from(agents)
  .where(and(eq(agents.userId, user.id), isNull(agents.archivedAt)));
```

Import `isNull` from `drizzle-orm` (add to the existing import on line 5 which already imports `eq, and, desc`).

This ensures archived agents are never offered as dispatch options by the chief-of-staff. The `and` import already exists.
  </action>
  <verify>
Run `npx tsc --noEmit -p apps/server/tsconfig.json` to verify TypeScript compiles without errors. Grep the file: the agent query should contain `isNull(agents.archivedAt)`.
  </verify>
  <done>Chat route queries only active (non-archived) agents for the chief-of-staff dispatch tools. TypeScript compiles cleanly.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npx tsc --noEmit -p apps/server/tsconfig.json` passes
2. Database schema pushed: `npx drizzle-kit push` succeeds
3. Schema exports: agentFeedback, agentVersions are exported from schema.ts
4. Archive filter: chat-route.ts agent query includes `isNull(agents.archivedAt)`
</verification>

<success_criteria>
- agentFeedback table with userId, agentId, executionId, rating, correction columns
- agentVersions table with agentId, version, systemPrompt, changeSource, changeSummary columns
- agents table has archivedAt nullable timestamp column
- Relations defined for both new tables
- Chat route excludes archived agents from dispatch
- All TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/04-agent-evolution/04-01-SUMMARY.md`
</output>
