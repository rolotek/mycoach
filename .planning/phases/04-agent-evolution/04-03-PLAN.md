---
phase: 04-agent-evolution
plan: "03"
type: execute
wave: 3
depends_on: ["04-02"]
files_modified:
  - apps/web/src/app/(app)/chat/components/agent-result.tsx
  - apps/web/src/app/(app)/chat/components/message-list.tsx
  - apps/web/src/app/(app)/agents/page.tsx
  - apps/web/src/app/(app)/agents/[id]/page.tsx
  - apps/server/src/agents/agent-executor.ts
autonomous: false

must_haves:
  truths:
    - "User can give thumbs up/down feedback on agent results in chat"
    - "User can add optional text correction on negative feedback"
    - "Agents page shows all agents including archived ones with visual distinction"
    - "User can archive and unarchive agents from the agents page"
    - "User can view version history for any agent"
    - "User can revert an agent to a previous prompt version"
  artifacts:
    - path: "apps/web/src/app/(app)/chat/components/agent-result.tsx"
      provides: "FeedbackButtons component on agent results"
      contains: "FeedbackButtons"
    - path: "apps/web/src/app/(app)/agents/page.tsx"
      provides: "Archive/unarchive buttons, listAll query"
      contains: "archive"
    - path: "apps/web/src/app/(app)/agents/[id]/page.tsx"
      provides: "Agent detail page with version history and revert"
      contains: "agentVersion"
  key_links:
    - from: "apps/web/src/app/(app)/chat/components/agent-result.tsx"
      to: "tRPC agentFeedback.create"
      via: "mutation call on thumbs up/down click"
      pattern: "agentFeedback\\.create"
    - from: "apps/web/src/app/(app)/agents/[id]/page.tsx"
      to: "tRPC agentVersion.list and agentVersion.revert"
      via: "query + mutation for version history"
      pattern: "agentVersion\\.(list|revert)"
    - from: "apps/web/src/app/(app)/agents/page.tsx"
      to: "tRPC agent.listAll, agent.archive, agent.unarchive"
      via: "query + mutations for archive lifecycle"
      pattern: "agent\\.(listAll|archive|unarchive)"
---

<objective>
Build the feedback collection UI in chat and the enhanced agent management page with version history, archive/unarchive, and agent detail view.

Purpose: Completes the user-facing experience for Phase 4 -- users can provide feedback on agent outputs (driving evolution) and manage their agent library with full version control and lifecycle management.
Output: FeedbackButtons on AgentResultCard, enhanced agents page with archive support, new agent detail page with version history and revert.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-agent-evolution/04-RESEARCH.md
@.planning/phases/04-agent-evolution/04-02-SUMMARY.md
@apps/web/src/app/(app)/chat/components/agent-result.tsx
@apps/web/src/app/(app)/chat/components/message-list.tsx
@apps/web/src/app/(app)/agents/page.tsx
@apps/server/src/agents/agent-executor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add FeedbackButtons to AgentResultCard in chat</name>
  <files>
    apps/web/src/app/(app)/chat/components/agent-result.tsx
    apps/web/src/app/(app)/chat/components/message-list.tsx
    apps/server/src/agents/agent-executor.ts
  </files>
  <action>
**1. Update `apps/server/src/agents/agent-executor.ts`:**

Add `agentId` to the return value so the UI can pass it to feedback. One-line change:
- In the return object of executeSpecialistAgent (the successful path), add `agentId: agent.id` alongside `agentName`, `result`, `executionId`.

**2. Update `apps/web/src/app/(app)/chat/components/agent-result.tsx`:**

Add a `FeedbackButtons` component and update `AgentResultCard`:

- Add imports: `useState` from "react", `trpc` from "@/lib/trpc"
- **FeedbackButtons component** (exported):
  - Props: `{ executionId: string; agentId: string }`
  - State: `submitted` (null | "positive" | "negative"), `showCorrection` (boolean), `correctionText` (string)
  - tRPC mutation: `trpc.agentFeedback.create.useMutation()`
  - When NOT submitted: show two buttons side by side in a border-t mt-2 pt-2 container:
    - Thumbs up: on click mutate with rating "positive", set submitted. Style: `rounded p-1.5 text-neutral-500 hover:bg-green-50 hover:text-green-600`. Label text: "+1".
    - Thumbs down: on click mutate with rating "negative", set submitted, set showCorrection true. Style: `rounded p-1.5 text-neutral-500 hover:bg-red-50 hover:text-red-600`. Label text: "-1".
  - When submitted = "positive": show "Thanks for the feedback" in neutral-500
  - When submitted = "negative" AND showCorrection: show textarea placeholder "What should have been different?", "Submit correction" button. On submit: mutate with correction text, setShowCorrection(false).
  - When submitted = "negative" AND !showCorrection: show "Noted -- this will help improve future results"

- **Update AgentResultCard props:** Add optional `executionId?: string` and `agentId?: string`. After the result div, render `<FeedbackButtons>` only when both are provided.

**3. Update `apps/web/src/app/(app)/chat/components/message-list.tsx`:**

In the `part.state === "output-available"` branch, extract `executionId` and `agentId` from the output and pass to AgentResultCard:

```typescript
const out = part.output as { agentName?: string; result?: string; executionId?: string; agentId?: string };
// ... existing name/result extraction ...
return (
  <div key={...} className="max-w-[85%]">
    <AgentResultCard
      agentName={name}
      result={result}
      executionId={out.executionId}
      agentId={out.agentId}
    />
  </div>
);
```

Update the MessageListMessage type to include `executionId` and `agentId` as optional fields in the output type.
  </action>
  <verify>
Run `npx tsc --noEmit -p apps/web/tsconfig.json` and `npx tsc --noEmit -p apps/server/tsconfig.json` to verify both compile. Confirm agent-result.tsx exports both AgentResultCard and FeedbackButtons.
  </verify>
  <done>AgentResultCard shows thumbs up/down feedback buttons below agent results. Negative feedback prompts for optional correction text. Feedback submits via tRPC agentFeedback.create mutation. executionId and agentId flow from agent-executor through tool output to the UI.</done>
</task>

<task type="auto">
  <name>Task 2: Enhance agents page with archive support and add agent detail page</name>
  <files>
    apps/web/src/app/(app)/agents/page.tsx
    apps/web/src/app/(app)/agents/[id]/page.tsx
  </files>
  <action>
**1. Update `apps/web/src/app/(app)/agents/page.tsx`:**

- Change query from `trpc.agent.list.useQuery()` to `trpc.agent.listAll.useQuery()`.
- Add mutations: `archiveMut = trpc.agent.archive.useMutation({ onSuccess: () => utils.agent.listAll.invalidate() })`, same for unarchiveMut with agent.unarchive.
- Update all existing mutation onSuccess callbacks to invalidate `agent.listAll` instead of `agent.list`.
- In agent card grid, for archived agents (a.archivedAt is truthy):
  - Add `opacity-60` to card container class
  - Show "Archived" badge: `<span className="rounded bg-neutral-200 px-1.5 py-0.5 text-xs text-neutral-600">Archived</span>`
- Update action buttons per agent:
  - Active agents: "Edit", "Archive" (neutral styled, calls archiveMut), link "View History" to `/agents/${a.id}`
  - Archived agents: "Unarchive" (calls unarchiveMut), link "View History". Hide Edit and Delete.
  - Replace the hard Delete button with Archive for active agents (soft-delete is safer).
- Wrap agent name in a link to `/agents/${a.id}` with hover:underline class.

**2. Create `apps/web/src/app/(app)/agents/[id]/page.tsx`:**

New agent detail page with version history:

- "use client" directive
- Imports: useParams from "next/navigation", trpc from "@/lib/trpc", useState from "react", Link from "next/link"
- Get `id` from useParams (cast as string)
- Queries:
  - `trpc.agent.listAll.useQuery()` -- find agent by id from list, client-side filter
  - `trpc.agentVersion.list.useQuery({ agentId: id })` -- version history
  - `trpc.agentFeedback.listByAgent.useQuery({ agentId: id })` -- feedback items
- Mutation: `trpc.agentVersion.revert.useMutation({ onSuccess: () => { utils.agentVersion.list.invalidate(); utils.agent.listAll.invalidate(); } })`

Page layout:
- Back link: `<Link href="/agents">Back to Agents</Link>`
- Agent header: icon, name, description, badges (Starter, Archived)
- Current system prompt in `<pre className="whitespace-pre-wrap rounded bg-neutral-50 p-4 font-mono text-sm max-h-64 overflow-y-auto">` block
- Feedback Summary section: total count, positive count, negative count as text
- Version History section:
  - Each version card shows: version number, changeSource badge (manual=blue, evolution=green, initial=neutral), changeSummary if present, createdAt as date string
  - "Revert to this version" button per version (calls revert mutation)
  - Expandable prompt preview: useState toggle, show/hide systemPrompt text for that version
  - Empty state: "No version history yet"

Style: match existing agents page (neutral-50 bg, white cards, border-neutral-200, Tailwind).
  </action>
  <verify>
Run `npx tsc --noEmit -p apps/web/tsconfig.json` to verify TypeScript compiles. Check that both files exist and export default components.
  </verify>
  <done>Agents page uses listAll, shows archive status with visual distinction, has archive/unarchive buttons, and links to detail page. Agent detail page shows current prompt, feedback summary, and version history with revert capability.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify Phase 4 end-to-end</name>
  <files>N/A</files>
  <action>Human verification of the complete agent evolution system.</action>
  <verify>
1. Start the dev server
2. Navigate to a chat and trigger an agent dispatch
3. After agent result appears, verify thumbs up/down buttons are visible below the result
4. Click thumbs down -- verify correction text input appears
5. Submit feedback with correction -- verify it submits without error
6. Navigate to /agents -- verify all agents shown with status
7. Click "View History" on an agent -- verify detail page loads with version history and feedback summary
8. Click "Archive" on an agent -- verify it shows as archived (dimmed with badge)
9. Start a new chat -- verify archived agent is NOT offered for dispatch
10. Go back to /agents, click "Unarchive" -- verify agent becomes active again
  </verify>
  <done>All Phase 4 features verified: feedback collection, archive/unarchive lifecycle, version history with revert, and archived agents excluded from dispatch.</done>
</task>

</tasks>

<verification>
1. TypeScript compiles: both apps/web and apps/server pass tsc --noEmit
2. Feedback buttons appear on agent result cards in chat
3. Thumbs down triggers correction input
4. Agents page shows all agents with archive/active distinction
5. Agent detail page shows version history and feedback summary
6. Archive/unarchive toggle works
7. Archived agents excluded from chat dispatch
</verification>

<success_criteria>
- EVOL-01: User can provide thumbs up/down feedback with optional correction on agent results
- EVOL-02: Prompt evolution pipeline connected (feedback.create triggers checkAndEvolveAgent)
- EVOL-03: User can view agents, see version history, revert to previous versions, and archive/unarchive
- All three success criteria from ROADMAP Phase 4 are met
</success_criteria>

<output>
After completion, create `.planning/phases/04-agent-evolution/04-03-SUMMARY.md`
</output>
