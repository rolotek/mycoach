---
phase: 08-projects
plan: 02
type: execute
wave: 1
depends_on: ["08-01"]
files_modified:
  - apps/server/src/trpc/router.ts
  - packages/shared (schemas if needed)
autonomous: true

must_haves:
  truths:
    - "project.list returns user's projects; project.get(id) returns one project with documents, links, milestones, tasks"
    - "project.create and project.update accept name, description, status, dueDate"
    - "project.addDocument, project.removeDocument, project.addLink, project.removeLink exist"
    - "project listMilestones/createMilestone/updateMilestone/deleteMilestone and same for tasks exist"
    - "All procedures enforce userId from auth context"
  artifacts:
    - path: "apps/server/src/trpc/router.ts"
      provides: "project router with list, get, create, update, delete, document/link/milestone/task sub-procedures"
      contains: "project"
  key_links:
    - from: "apps/server/src/trpc/router.ts"
      to: "apps/server/src/db/schema.ts"
      via: "project tables"
      pattern: "projects"

<objective>
Implement tRPC project router: CRUD for projects, attach/detach documents and links, CRUD for milestones and tasks. Enforce userId on all operations. project.get returns project with nested documents (id, filename), links, milestones, tasks for the detail page.
</objective>

<context>
@.planning/phases/08-projects-user-defined-projects-e-g-improve-nda-templates-write-sci-fi-novel-onboarding-plan-with-definition-documents-artifacts-e-g-sharepoint-links-for-context-milestones-and-tasks/08-RESEARCH.md
@apps/server/src/trpc/router.ts
@apps/server/src/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add project tRPC router with CRUD and nested procedures</name>
  <files>apps/server/src/trpc/router.ts, packages/shared (if input schemas needed)</files>
  <action>
1. Create project router (or merge into existing router under project.*):
   - list: query, auth required; select from projects where userId = ctx.user.id; order by updatedAt desc.
   - get: query input { id }; auth; select project where id and userId; include documents (join project_documents + documents, return document id and filename), project_links, project_milestones, project_tasks (include conversationId for task thread link).
   - create: mutation input { name, description?, status?, dueDate? }; auth; insert project with userId.
   - update: mutation input { id, name?, description?, status?, dueDate? }; auth; update project where id and userId.
   - delete: mutation input { id }; auth; delete project where id and userId (cascade will remove project_documents, project_links, milestones, tasks).

2. Document/link procedures:
   - addDocument: mutation { projectId, documentId }; verify project and document belong to user; insert project_documents.
   - removeDocument: mutation { projectId, documentId }; verify project ownership; delete from project_documents.
   - addLink: mutation { projectId, url, label }; verify project ownership; insert project_links.
   - removeLink: mutation { projectId, linkId }; verify project ownership; delete from project_links.

3. Milestone procedures:
   - listMilestones: query { projectId }; auth; return milestones for project where user owns project.
   - createMilestone: mutation { projectId, title, dueDate?, sortOrder? }; auth; insert.
   - updateMilestone: mutation { id, title?, dueDate?, sortOrder?, status? }; auth; verify milestone's project belongs to user; update.
   - deleteMilestone: mutation { id }; auth; verify ownership; delete.

4. Task procedures:
   - listTasks: query { projectId }; auth; return tasks for project.
   - createTask: mutation { projectId, title, description?, status?, dueDate? }; auth; insert.
   - updateTask: mutation { id, title?, description?, status?, dueDate?, conversationId? }; auth; verify ownership; update.
   - deleteTask: mutation { id }; auth; verify ownership; delete.

Use Zod or existing shared schemas for input validation. Export project router and mount in root router.
</action>
</task>

</tasks>

<verification>
- project.list and project.get return expected shape; create/update/delete persist.
- addDocument fails if document belongs to another user; addLink/removeLink work.
- Milestone and task CRUD work and are scoped to project owner.
</verification>
