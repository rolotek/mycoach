---
phase: 08-projects
plan: 06
type: execute
wave: 1
depends_on: ["08-04"]
files_modified:
  - apps/server/src/db/schema.ts
  - apps/server/src/trpc/router.ts
  - apps/web/src/app/[locale]/(app)/projects/[id]/page.tsx
  - apps/web/src/lib/link-type-utils.ts
  - apps/web/messages/en.json
autonomous: true

must_haves:
  truths:
    - "External links have a detected type (sharepoint, google-docs, notion, github, generic) based on URL pattern"
    - "Each link displays an appropriate icon based on its type"
    - "User can upload a new document directly from the project detail page and it auto-attaches to the project"
  artifacts:
    - path: "apps/server/src/db/schema.ts"
      provides: "linkType column on project_links table"
      contains: "linkType"
    - path: "apps/server/src/trpc/router.ts"
      provides: "addLink auto-detects linkType from URL"
      contains: "detectLinkType"
    - path: "apps/web/src/lib/link-type-utils.ts"
      provides: "getLinkIcon helper mapping linkType to lucide icon"
      contains: "getLinkIcon"
    - path: "apps/web/src/app/[locale]/(app)/projects/[id]/page.tsx"
      provides: "Typed link icons in links list and upload button in documents section"
      contains: "getLinkIcon"
  key_links:
    - from: "apps/server/src/trpc/router.ts"
      to: "apps/server/src/db/schema.ts"
      via: "linkType written on insert"
      pattern: "linkType.*detect"
    - from: "apps/web/src/app/[locale]/(app)/projects/[id]/page.tsx"
      to: "apps/web/src/lib/link-type-utils.ts"
      via: "import getLinkIcon for rendering"
      pattern: "getLinkIcon"
---

<objective>
Add typed external links with auto-detection and icons, plus direct document upload from the project detail page.

Purpose: Per locked decisions: "External links are typed -- recognize link type (SharePoint, Google Docs, etc.) and show appropriate icon" and "Users can attach existing uploaded documents OR upload new ones directly from the project page."

Output: linkType column on project_links, URL-to-type detection, icon mapping utility, document upload button on project detail that uploads + auto-attaches.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-projects-user-defined-projects-e-g-improve-nda-templates-write-sci-fi-novel-onboarding-plan-with-definition-documents-artifacts-e-g-sharepoint-links-for-context-milestones-and-tasks/08-01-SUMMARY.md
@.planning/phases/08-projects-user-defined-projects-e-g-improve-nda-templates-write-sci-fi-novel-onboarding-plan-with-definition-documents-artifacts-e-g-sharepoint-links-for-context-milestones-and-tasks/08-02-SUMMARY.md
@.planning/phases/08-projects-user-defined-projects-e-g-improve-nda-templates-write-sci-fi-novel-onboarding-plan-with-definition-documents-artifacts-e-g-sharepoint-links-for-context-milestones-and-tasks/08-04-SUMMARY.md

@apps/web/src/app/[locale]/(app)/documents/page.tsx (for uploadDocument pattern)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add linkType column, auto-detect utility, and update addLink procedure</name>
  <files>apps/server/src/db/schema.ts, apps/server/src/trpc/router.ts</files>
  <action>
1. In `apps/server/src/db/schema.ts`, add to `projectLinks`:
   - `linkType: varchar("link_type", { length: 50 }).default("generic").notNull()`

2. Run `npx drizzle-kit generate` to create a migration.

3. In `apps/server/src/trpc/router.ts`, add a helper function `detectLinkType(url: string): string` before the projectRouter:
   - Check URL hostname patterns:
     - `sharepoint.com` or `*.sharepoint.com` -> "sharepoint"
     - `docs.google.com` or `drive.google.com` or `sheets.google.com` or `slides.google.com` -> "google-docs"
     - `notion.so` or `*.notion.site` -> "notion"
     - `github.com` or `*.github.com` -> "github"
     - `gitlab.com` -> "gitlab"
     - `figma.com` -> "figma"
     - `confluence` in hostname -> "confluence"
     - `dropbox.com` -> "dropbox"
     - Everything else -> "generic"
   - Use `new URL(url)` with try/catch; on parse failure return "generic"

4. Update the `project.addLink` procedure:
   - After validating the input, call `detectLinkType(input.url)` to get the linkType
   - Include `linkType` in the insert values
   - Return linkType in the response

5. Update `project.get` to include linkType in the links select (it should already be returned since it selects all columns from projectLinks, but verify).
  </action>
  <verify>
   - `npx tsc --noEmit` passes
   - Migration file exists for linkType column
   - Adding a SharePoint link sets linkType to "sharepoint"
   - Adding a GitHub link sets linkType to "github"
   - Adding an unknown URL sets linkType to "generic"
  </verify>
  <done>project_links table has linkType column, addLink auto-detects type from URL pattern, project.get returns linkType for each link</done>
</task>

<task type="auto">
  <name>Task 2: Add link type icons and document upload button to project detail page</name>
  <files>apps/web/src/lib/link-type-utils.ts, apps/web/src/app/[locale]/(app)/projects/[id]/page.tsx, apps/web/messages/en.json</files>
  <action>
1. Create `apps/web/src/lib/link-type-utils.ts`:
   - Export a function `getLinkIcon(linkType: string)` that returns the appropriate lucide-react icon component:
     - "sharepoint" -> `FileSpreadsheet` (or `Globe` with a note)
     - "google-docs" -> `FileText`
     - "notion" -> `BookOpen`
     - "github" -> `Github` (lucide has this)
     - "gitlab" -> `GitBranch`
     - "figma" -> `Figma` (lucide has this)
     - "confluence" -> `BookOpen`
     - "dropbox" -> `Cloud`
     - "generic" -> `ExternalLink`
   - Use `import { FileText, BookOpen, Github, GitBranch, Figma, Cloud, ExternalLink, FileSpreadsheet } from "lucide-react"`
   - Return the component reference (not JSX), so caller can use `<Icon className="..." />`

2. In `apps/web/messages/en.json`, add to "projects" namespace:
   - `"uploadDocument": "Upload & attach"`, `"uploading": "Uploading..."`

3. In `apps/web/src/app/[locale]/(app)/projects/[id]/page.tsx`:

   a. **Typed link icons:** In the links list, replace the hardcoded `<ExternalLink>` icon with:
      - Import `getLinkIcon` from `@/lib/link-type-utils`
      - For each link, call `const LinkIcon = getLinkIcon(l.linkType ?? "generic")`
      - Render `<LinkIcon className="ml-1 inline h-3 w-3" />` instead of `<ExternalLink className="ml-1 inline h-3 w-3" />`

   b. **Document upload from project page:** In the documents section, add an upload button alongside the attach-existing dropdown:
      - Add a hidden file input ref: `const fileInputRef = useRef<HTMLInputElement>(null)`
      - Add state: `const [uploading, setUploading] = useState(false)`
      - Add the upload handler that reuses the same `uploadDocument` pattern from the documents page:
        ```
        async function handleUploadAndAttach(file: File) {
          setUploading(true);
          try {
            const formData = new FormData();
            formData.append("file", file);
            const res = await fetch(`${SERVER_URL}/api/documents/upload`, {
              method: "POST",
              body: formData,
              credentials: "include",
            });
            if (!res.ok) throw new Error("Upload failed");
            const doc = await res.json();
            // Auto-attach the newly uploaded document to this project
            addDocument.mutate({ projectId: id, documentId: doc.id });
          } finally {
            setUploading(false);
          }
        }
        ```
      - Render an "Upload & attach" button next to the attach-existing Select:
        ```
        <Button size="sm" variant="outline" onClick={() => fileInputRef.current?.click()} disabled={uploading}>
          <Upload className="mr-1 h-3 w-3" />
          {uploading ? t("uploading") : t("uploadDocument")}
        </Button>
        <input ref={fileInputRef} type="file" accept=".pdf,.docx,.txt,.doc" hidden
          onChange={(e) => { if (e.target.files?.[0]) handleUploadAndAttach(e.target.files[0]); e.target.value = ""; }}
        />
        ```
      - Import `Upload` from lucide-react, `useRef` from react
      - Define SERVER_URL at the top like the documents page does: `const SERVER_URL = process.env.NEXT_PUBLIC_SERVER_URL || "http://localhost:3001"`
  </action>
  <verify>
   - `npx tsc --noEmit` passes
   - Links display type-specific icons (GitHub link shows GitHub icon, etc.)
   - "Upload & attach" button opens file picker, uploads document, and attaches it to the project
   - Newly uploaded document appears in the attached documents list after upload
  </verify>
  <done>External links show type-specific icons based on detected linkType, and users can upload new documents directly from the project detail page which auto-attaches them</done>
</task>

</tasks>

<verification>
1. Add a SharePoint link (e.g. https://contoso.sharepoint.com/doc) -- verify type icon is not generic
2. Add a GitHub link (e.g. https://github.com/user/repo) -- verify GitHub icon shows
3. Add a generic link (e.g. https://example.com) -- verify generic external link icon
4. Click "Upload & attach" -- select a .txt file -- verify it uploads AND appears in attached documents list
5. Navigate to /documents page -- verify the uploaded document also appears there
</verification>

<success_criteria>
- Every link in the links list shows an icon reflecting its detected type
- Auto-detection covers sharepoint, google-docs, notion, github, gitlab, figma, confluence, dropbox, and generic
- Upload button on project page uploads file to server and attaches to project in one action
- No duplicate code with documents page upload logic (reused fetch pattern)
</success_criteria>

<output>
After completion, create `.planning/phases/08-projects-user-defined-projects-e-g-improve-nda-templates-write-sci-fi-novel-onboarding-plan-with-definition-documents-artifacts-e-g-sharepoint-links-for-context-milestones-and-tasks/08-06-SUMMARY.md`
</output>
