---
phase: 08-projects
plan: 03
type: execute
wave: 2
depends_on: ["08-02"]
files_modified:
  - apps/server/src/coaching/chat-route.ts
  - apps/server/src/agents/chief-of-staff.ts (or chat route body parsing)
  - apps/web (chat page or provider to pass projectId)
autonomous: true

must_haves:
  truths:
    - "Chat API accepts optional projectId in request body; when present, project context (name, description, document names, link labels+urls) is injected into system or context for the coach"
    - "New task conversations created from chat can store projectId on the conversation when user is in project context"
    - "Agent executions store projectId when the conversation has projectId (or request body has projectId)"
  artifacts:
    - path: "apps/server/src/coaching/chat-route.ts"
      provides: "Project context injection when projectId provided"
      contains: "projectId"
  key_links:
    - from: "apps/server/src/coaching/chat-route.ts"
      to: "project.get or project context loader"
      via: "fetch project and format for prompt"
      pattern: "project"
</must_haves>

<objective>
Integrate projects with chat and agents: accept optional projectId in chat request; load project (name, description, attached document names, links with label+url); inject into system/context so the coach and chief-of-staff have project context. When creating task threads or agent executions, set projectId when in project context so tasks and work are associated with the project.
</objective>

<context>
@.planning/phases/08-projects-user-defined-projects-e-g-improve-nda-templates-write-sci-fi-novel-onboarding-plan-with-definition-documents-artifacts-e-g-sharepoint-links-for-context-milestones-and-tasks/08-RESEARCH.md
@apps/server/src/coaching/chat-route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Chat route accepts projectId and injects project context</name>
  <files>apps/server/src/coaching/chat-route.ts, API body schema</files>
  <action>
1. In chat route (or transport body): accept optional projectId in the request body (with chatId, mode). If projectId present, load project via db (get project where id and userId from auth). If not found or wrong user, ignore projectId.

2. Build project context string: "Project: {name}\nDescription: {description}\nAttached documents: {list of document filenames}\nLinks: {label}: {url} for each link". If no project or load fails, use empty string.

3. Prepend or append project context to the system prompt (or a dedicated context block) passed to streamText so the model sees the project. Do not fetch or ingest link URLs; only include them as text.

4. When creating a new conversation (e.g. task thread), if projectId was in request and valid, set conversation.projectId. When recording agent execution, set agentExecution.projectId from conversation.projectId if present.
</action>
</task>

<task type="auto">
  <name>Task 2: Web app passes projectId when user is in project context</name>
  <files>apps/web: chat input or chat page, project detail page</files>
  <action>
1. Chat transport (useChat body or equivalent): include optional projectId when user has selected "chat for this project" (e.g. from project detail page or a global "current project" selector). If the chat page is opened from a project (e.g. /chat?projectId=xxx or /projects/[id]/chat), pass that projectId in every message body.

2. Project detail page: add "Open chat for this project" button that navigates to /chat with projectId in query or state so the chat page sends projectId with messages. Ensure chat page reads projectId from URL or context and includes it in the API request body.
</action>
</task>

</tasks>

<verification>
- Sending a message with projectId results in project name/description/artifacts visible in system/context (e.g. inspect logs or a test that mocks project load).
- New task thread created while projectId is set has conversation.projectId set; agent execution has projectId when conversation has it.
</verification>
