---
phase: 08-projects
plan: 08
type: execute
wave: 3
depends_on: ["08-07"]
files_modified:
  - apps/web/src/app/[locale]/(app)/chat/[id]/page.tsx
  - apps/web/src/components/app-sidebar.tsx
  - apps/web/src/components/chat-context-badge.tsx
  - apps/server/src/trpc/router.ts
  - apps/web/messages/en.json
autonomous: true

must_haves:
  truths:
    - "Chat UI shows a context badge indicating which project and section (if any) plus document count are scoped in"
    - "Project-scoped chat threads are visible in the sidebar, tagged with the project name"
    - "Sidebar project threads are grouped or labeled differently from regular threads"
  artifacts:
    - path: "apps/web/src/components/chat-context-badge.tsx"
      provides: "Context badge component showing project name, section name, and doc count"
      contains: "ChatContextBadge"
    - path: "apps/web/src/components/app-sidebar.tsx"
      provides: "Project threads section in sidebar"
      contains: "projectId"
    - path: "apps/server/src/trpc/router.ts"
      provides: "conversation.listProjectThreads or updated conversation.list with project info"
      contains: "projectId"
  key_links:
    - from: "apps/web/src/components/chat-context-badge.tsx"
      to: "trpc.project.get"
      via: "fetches project name and milestone name to build badge text"
      pattern: "project\\.get"
    - from: "apps/web/src/components/app-sidebar.tsx"
      to: "trpc.conversation.listProjectThreads or similar"
      via: "fetches project-scoped threads for sidebar display"
      pattern: "projectId"
---

<objective>
Add a context badge in chat showing what project/section context is active, and display project-scoped threads in the sidebar tagged with project names.

Purpose: Per locked decisions: "Show context badge in chat (e.g. 'Using: NDA Template > Section 3 + 2 docs') so user knows what's scoped in" and "'Open chat' button on project page AND project threads visible in sidebar (tagged with project name)."

Output: ChatContextBadge component, project threads section in sidebar, conversation.listProjectThreads tRPC procedure.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-projects-user-defined-projects-e-g-improve-nda-templates-write-sci-fi-novel-onboarding-plan-with-definition-documents-artifacts-e-g-sharepoint-links-for-context-milestones-and-tasks/08-03-SUMMARY.md
@.planning/phases/08-projects-user-defined-projects-e-g-improve-nda-templates-write-sci-fi-novel-onboarding-plan-with-definition-documents-artifacts-e-g-sharepoint-links-for-context-milestones-and-tasks/08-04-SUMMARY.md

@apps/web/src/components/app-sidebar.tsx
@apps/web/src/app/[locale]/(app)/chat/[id]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add conversation.listProjectThreads tRPC procedure and ChatContextBadge component</name>
  <files>apps/server/src/trpc/router.ts, apps/web/src/components/chat-context-badge.tsx, apps/web/src/app/[locale]/(app)/chat/[id]/page.tsx, apps/web/messages/en.json</files>
  <action>
1. In `apps/server/src/trpc/router.ts`, add a `conversation.listProjectThreads` procedure (or add it to an existing conversation router if one exists):
   - No input needed (uses userId from auth context)
   - Query conversations WHERE projectId IS NOT NULL AND userId = currentUser
   - Join with projects table to get project name
   - Join with projectMilestones table to get milestone title (when milestoneId is set)
   - Return: `{ id, title, projectId, projectName, milestoneId, milestoneName, updatedAt }`
   - Order by updatedAt DESC
   - Group by projectId in the response shape (or return flat list -- let the UI group)

2. In `apps/web/messages/en.json`, add to "projects" namespace:
   - `"usingContext": "Using"`, `"contextDocs": "docs"`, `"contextLinks": "links"`, `"projectThreads": "Project threads"`, `"noProjectThreads": "No project threads yet."`

3. Create `apps/web/src/components/chat-context-badge.tsx`:
   - Export `ChatContextBadge({ projectId, milestoneId }: { projectId?: string | null; milestoneId?: string | null })`
   - If no projectId, return null
   - Use `trpc.project.get.useQuery({ id: projectId }, { enabled: !!projectId })` to fetch project details
   - Build the badge text:
     - Project name (always)
     - ` > {milestone title}` if milestoneId is present (find milestone in project.milestones array)
     - ` + {N} docs` where N = count of project_documents matching (project-level + section-level if milestoneId)
     - ` + {M} links` where M = count of matching links
   - Render as a small `<Badge variant="secondary">` or a compact info bar at the top of the chat area:
     ```
     <div className="flex items-center gap-1.5 rounded-md bg-muted px-3 py-1.5 text-xs text-muted-foreground">
       <FolderKanban className="h-3 w-3" />
       <span>Using: {projectName}{sectionPart} + {N} docs</span>
     </div>
     ```
   - Import FolderKanban from lucide-react

4. In `apps/web/src/app/[locale]/(app)/chat/[id]/page.tsx`:
   - Import ChatContextBadge
   - Read projectId and milestoneId from searchParams (projectId should already be read per 08-03; add milestoneId per 08-07)
   - Also check the conversation object for projectId/milestoneId if loaded (fallback)
   - Render `<ChatContextBadge projectId={projectId} milestoneId={milestoneId} />` above the message list area
  </action>
  <verify>
   - `npx tsc --noEmit` passes
   - Chat page with projectId shows badge "Using: {Project Name} + N docs"
   - Chat page with projectId + milestoneId shows badge "Using: {Project Name} > {Section Name} + N docs"
   - Chat page without projectId shows no badge
   - conversation.listProjectThreads returns project-scoped threads with names
  </verify>
  <done>Context badge component renders in chat showing project name, optional section name, and doc/link count; listProjectThreads procedure provides data for sidebar</done>
</task>

<task type="auto">
  <name>Task 2: Add project threads section to sidebar</name>
  <files>apps/web/src/components/app-sidebar.tsx, apps/web/messages/en.json</files>
  <action>
1. In `apps/web/src/components/app-sidebar.tsx`:
   - Import trpc: `import { trpc } from "@/lib/trpc"`
   - Import additional icons: `import { MessageSquareDot } from "lucide-react"` (or use MessageSquare with a badge)
   - Call `trpc.conversation.listProjectThreads.useQuery()` to fetch project-scoped threads
   - Below the navigation SidebarGroup, add a new SidebarGroup for project threads:
     ```
     <SidebarGroup>
       <SidebarGroupLabel>{t("projectThreads")}</SidebarGroupLabel>
       <SidebarGroupContent>
         <SidebarMenu>
           {projectThreads?.map((thread) => (
             <SidebarMenuItem key={thread.id}>
               <SidebarMenuButton asChild isActive={pathname === `/chat/${thread.id}`}>
                 <Link href={`/chat/${thread.id}?projectId=${thread.projectId}${thread.milestoneId ? `&milestoneId=${thread.milestoneId}` : ''}`}>
                   <FolderKanban className="h-4 w-4" />
                   <div className="flex flex-col">
                     <span className="text-sm truncate">{thread.title || "Untitled"}</span>
                     <span className="text-xs text-muted-foreground truncate">
                       {thread.projectName}{thread.milestoneName ? ` > ${thread.milestoneName}` : ''}
                     </span>
                   </div>
                 </Link>
               </SidebarMenuButton>
             </SidebarMenuItem>
           ))}
           {(!projectThreads || projectThreads.length === 0) && (
             <p className="px-2 py-1 text-xs text-muted-foreground">{t("noProjectThreads")}</p>
           )}
         </SidebarMenu>
       </SidebarGroupContent>
     </SidebarGroup>
     ```
   - Only show this section if the query has loaded (to avoid flicker)
   - Limit to most recent 10 threads to keep sidebar manageable
   - Add FolderKanban to imports

2. In `apps/web/messages/en.json`, add to "sidebar" namespace:
   - `"projectThreads": "Project threads"`, `"noProjectThreads": "No project threads yet."`
  </action>
  <verify>
   - `npx tsc --noEmit` passes
   - Sidebar shows "Project threads" section with project-scoped conversations
   - Each thread shows its title and the project name (+ section name if applicable)
   - Clicking a thread navigates to the chat with projectId and milestoneId preserved in URL
   - No project threads section shown when user has no project-scoped conversations (or shows empty state text)
  </verify>
  <done>Sidebar displays a "Project threads" section showing recent project-scoped conversations tagged with project name and optional section name</done>
</task>

</tasks>

<verification>
1. Create a project "NDA Template" with milestone "Section 3" and attach 2 docs at project level
2. Open chat from the project -- verify badge shows "Using: NDA Template + 2 docs"
3. Open chat from milestone "Section 3" -- verify badge shows "Using: NDA Template > Section 3 + N docs"
4. Check sidebar -- verify the new threads appear under "Project threads" with "NDA Template" label
5. Click a project thread in sidebar -- verify it navigates to chat with correct projectId/milestoneId
6. Chat without any project context -- verify no badge and no impact on sidebar section
</verification>

<success_criteria>
- Context badge in chat clearly shows what project/section is scoped with doc/link count
- Badge is non-intrusive (small, muted styling) but visible
- Project threads in sidebar are visually distinct from regular navigation items
- Sidebar threads link correctly with projectId and milestoneId in URL
</success_criteria>

<output>
After completion, create `.planning/phases/08-projects-user-defined-projects-e-g-improve-nda-templates-write-sci-fi-novel-onboarding-plan-with-definition-documents-artifacts-e-g-sharepoint-links-for-context-milestones-and-tasks/08-08-SUMMARY.md`
</output>
