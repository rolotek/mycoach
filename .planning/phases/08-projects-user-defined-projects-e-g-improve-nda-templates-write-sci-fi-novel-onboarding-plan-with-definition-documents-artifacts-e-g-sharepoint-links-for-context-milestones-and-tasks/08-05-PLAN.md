---
phase: 08-projects
plan: 05
type: execute
wave: 1
depends_on: ["08-04"]
files_modified:
  - apps/server/src/db/schema.ts
  - apps/server/src/trpc/router.ts
  - apps/web/src/app/[locale]/(app)/projects/page.tsx
  - apps/web/messages/en.json
autonomous: true

must_haves:
  truths:
    - "Pinned projects appear at the top of the project list, ordered by pin time"
    - "User can pin and unpin a project from the project list"
    - "Completed and archived projects are hidden from the default list view"
    - "User can toggle a filter to show completed/archived projects"
  artifacts:
    - path: "apps/server/src/db/schema.ts"
      provides: "pinnedAt column on projects table"
      contains: "pinnedAt"
    - path: "apps/server/src/trpc/router.ts"
      provides: "project.togglePin procedure and updated project.list sort"
      contains: "togglePin"
    - path: "apps/web/src/app/[locale]/(app)/projects/page.tsx"
      provides: "Pin/unpin button on project cards, show archived toggle"
      contains: "pinnedAt"
  key_links:
    - from: "apps/web/src/app/[locale]/(app)/projects/page.tsx"
      to: "trpc.project.togglePin"
      via: "mutation call on pin button click"
      pattern: "project\\.togglePin\\.useMutation"
    - from: "apps/server/src/trpc/router.ts"
      to: "apps/server/src/db/schema.ts"
      via: "pinnedAt column in project.list ORDER BY"
      pattern: "pinnedAt"
---

<objective>
Add project pinning, smart list sorting, and archived/completed project filtering.

Purpose: Users need to pin active projects to the top and hide completed/archived ones from the default view, per locked decision "Pinned + recent: user can pin active projects to top, rest sorted by recent activity below" and "Completed/archived projects hidden from default list, accessible via filter."

Output: pinnedAt column on projects, togglePin tRPC procedure, updated project.list with pinned-first sort and status filter, UI with pin buttons and show-archived toggle.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-projects-user-defined-projects-e-g-improve-nda-templates-write-sci-fi-novel-onboarding-plan-with-definition-documents-artifacts-e-g-sharepoint-links-for-context-milestones-and-tasks/08-01-SUMMARY.md
@.planning/phases/08-projects-user-defined-projects-e-g-improve-nda-templates-write-sci-fi-novel-onboarding-plan-with-definition-documents-artifacts-e-g-sharepoint-links-for-context-milestones-and-tasks/08-02-SUMMARY.md
@.planning/phases/08-projects-user-defined-projects-e-g-improve-nda-templates-write-sci-fi-novel-onboarding-plan-with-definition-documents-artifacts-e-g-sharepoint-links-for-context-milestones-and-tasks/08-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pinnedAt column and update project.list sort with status filter + togglePin procedure</name>
  <files>apps/server/src/db/schema.ts, apps/server/src/trpc/router.ts</files>
  <action>
1. In `apps/server/src/db/schema.ts`, add to the `projects` table:
   - `pinnedAt: timestamp("pinned_at")` (nullable, no default)

2. Run `npx drizzle-kit generate` to create a migration for the new column.

3. In `apps/server/src/trpc/router.ts`, update the existing `project.list` procedure:
   - Accept an optional input: `{ showArchived?: boolean }` (default false)
   - When `showArchived` is false (default), filter WHERE status NOT IN ('completed', 'archived')
   - When `showArchived` is true, return all projects (no status filter)
   - ORDER BY: `pinnedAt DESC NULLS LAST, updatedAt DESC` — this puts pinned projects first (most recently pinned at top), then unpinned sorted by recent activity
   - Return pinnedAt in the select so the UI knows pin state

4. Add `project.togglePin` procedure:
   - Input: `{ id: string }`
   - Verify project belongs to user (ownership check like other project procedures)
   - If project.pinnedAt is null, set it to `new Date()`
   - If project.pinnedAt is not null, set it to `null`
   - Return the updated project
  </action>
  <verify>
   - `npx tsc --noEmit` passes (no type errors)
   - Migration file exists in drizzle directory
   - project.list with no input returns only active projects, sorted pinned-first then by updatedAt
   - project.togglePin toggles the pinnedAt value
  </verify>
  <done>project.list sorts pinned first then by updatedAt, filters out completed/archived by default, and project.togglePin flips pinnedAt between timestamp and null</done>
</task>

<task type="auto">
  <name>Task 2: Add pin/unpin button and show-archived toggle to projects list UI</name>
  <files>apps/web/src/app/[locale]/(app)/projects/page.tsx, apps/web/messages/en.json</files>
  <action>
1. In `apps/web/messages/en.json`, add to the "projects" namespace:
   - `"pin": "Pin"`, `"unpin": "Unpin"`, `"pinned": "Pinned"`
   - `"showArchived": "Show completed & archived"`, `"hideArchived": "Hide completed & archived"`

2. In `apps/web/src/app/[locale]/(app)/projects/page.tsx`:
   - Add state: `const [showArchived, setShowArchived] = useState(false)`
   - Update the query: `trpc.project.list.useQuery({ showArchived })`
   - Add a `trpc.project.togglePin.useMutation` with `onSuccess: () => utils.project.list.invalidate()`
   - Above the project list, render a toggle/checkbox: "Show completed & archived" that flips showArchived state
   - On each project card, add a Pin/Unpin icon button (use lucide `Pin` icon):
     - If project.pinnedAt is truthy, show filled pin icon with "Unpin" tooltip/aria-label
     - If project.pinnedAt is falsy, show outline pin icon with "Pin" tooltip/aria-label
     - onClick calls togglePin.mutate({ id: project.id })
     - Position the pin button on the left side of the card or inline with the name
   - For pinned projects, optionally show a small "Pinned" badge near the status badge
   - Use `import { Pin } from "lucide-react"` for the icon

3. Ensure the card still links to `/projects/[id]` and that clicking the pin button does NOT navigate (use `e.stopPropagation()` and `e.preventDefault()` on the pin button's onClick).
  </action>
  <verify>
   - `npx tsc --noEmit` passes
   - Projects list shows pin/unpin button on each card
   - Clicking pin moves project to top of list
   - Toggle "Show completed & archived" reveals/hides completed/archived projects
   - Pin button click does not navigate to project detail
  </verify>
  <done>Projects list page has pin/unpin buttons on each card, pinned projects appear at top, and a toggle to show/hide completed and archived projects</done>
</task>

</tasks>

<verification>
1. Create a project, pin it — verify it appears at top
2. Create a second project — verify the pinned one stays at top, new unpinned one appears below
3. Mark a project as "completed" from detail page — verify it disappears from default list
4. Toggle "Show completed & archived" — verify completed project reappears
5. Unpin a project — verify sort reverts to updatedAt order
</verification>

<success_criteria>
- Pinned projects always appear above unpinned projects in the list
- Completed and archived projects are hidden by default
- Show-archived toggle reveals all projects
- Pin/unpin is a single click with instant visual feedback
</success_criteria>

<output>
After completion, create `.planning/phases/08-projects-user-defined-projects-e-g-improve-nda-templates-write-sci-fi-novel-onboarding-plan-with-definition-documents-artifacts-e-g-sharepoint-links-for-context-milestones-and-tasks/08-05-SUMMARY.md`
</output>
