---
phase: 08-projects
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/server/src/db/schema.ts
autonomous: true

must_haves:
  truths:
    - "projects table exists with userId, name, description, status, dueDate, createdAt, updatedAt"
    - "project_documents join table exists (projectId, documentId) with FKs and unique constraint"
    - "project_links table exists with projectId, url, label, id, createdAt"
    - "project_milestones table exists with projectId, title, dueDate, sortOrder, status"
    - "project_tasks table exists with projectId, optional milestoneId (FK to project_milestones, onDelete set null), title, description, status, dueDate, conversationId (optional FK)"
    - "conversations table has optional projectId FK; agentExecutions has optional projectId FK"
  artifacts:
    - path: "apps/server/src/db/schema.ts"
      provides: "projects, project_documents, project_links, project_milestones, project_tasks; projectId on conversations and agentExecutions"
      contains: "projects"
  key_links:
    - from: "apps/server/src/db/schema.ts"
      to: "user.id, documents.id, conversations.id"
      via: "FK references"
      pattern: "references"
---

<objective>
Create the database foundation for Phase 8 Projects: projects table, project_documents (link to existing documents), project_links (external URLs e.g. SharePoint), project_milestones, project_tasks (optional conversationId to link task threads). Add optional projectId to conversations and agentExecutions so chat and agent work can be scoped to a project.
</objective>

<context>
@.planning/phases/08-projects-user-defined-projects-e-g-improve-nda-templates-write-sci-fi-novel-onboarding-plan-with-definition-documents-artifacts-e-g-sharepoint-links-for-context-milestones-and-tasks/08-RESEARCH.md
@apps/server/src/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add projects and project artifact tables</name>
  <files>apps/server/src/db/schema.ts</files>
  <action>
In apps/server/src/db/schema.ts:

1. Add `projects` table:
   - id: uuid PK defaultRandom
   - userId: text FK user.id onDelete cascade
   - name: text notNull
   - description: text (nullable)
   - status: varchar(50) default 'active' (e.g. active | completed | archived)
   - dueDate: timestamp nullable
   - createdAt, updatedAt: timestamp defaultNow notNull
   - Index: projects_userId_idx on userId

2. Add `project_documents` table (many-to-many projects <-> documents):
   - id: uuid PK defaultRandom
   - projectId: uuid FK projects.id onDelete cascade
   - documentId: uuid FK documents.id onDelete cascade
   - createdAt: timestamp defaultNow notNull
   - Unique: (projectId, documentId)
   - Index: project_documents_projectId_idx on projectId

3. Add `project_links` table (external URLs):
   - id: uuid PK defaultRandom
   - projectId: uuid FK projects.id onDelete cascade
   - url: text notNull
   - label: text notNull
   - createdAt: timestamp defaultNow notNull
   - Index: project_links_projectId_idx on projectId

4. Add `project_milestones` table:
   - id: uuid PK defaultRandom
   - projectId: uuid FK projects.id onDelete cascade
   - title: text notNull
   - dueDate: timestamp nullable
   - sortOrder: integer notNull default 0
   - status: varchar(50) nullable (e.g. pending | done)
   - createdAt: timestamp defaultNow notNull
   - Index: project_milestones_projectId_idx on projectId

5. Add `project_tasks` table:
   - id: uuid PK defaultRandom
   - projectId: uuid FK projects.id onDelete cascade
   - milestoneId: uuid nullable FK project_milestones.id onDelete set null (links task to a milestone)
   - title: text notNull
   - description: text nullable
   - status: varchar(50) default 'todo' (e.g. todo | in_progress | done)
   - dueDate: timestamp nullable
   - conversationId: uuid nullable FK conversations.id onDelete set null
   - createdAt, updatedAt: timestamp defaultNow notNull
   - Index: project_tasks_projectId_idx, project_tasks_milestoneId_idx, project_tasks_conversationId_idx

6. Add optional projectId to conversations table:
   - projectId: uuid nullable FK projects.id onDelete set null
   - Index: conversations_projectId_idx on projectId

7. Add optional projectId to agentExecutions table:
   - projectId: uuid nullable FK projects.id onDelete set null
   - Index: agent_executions_projectId_idx on projectId

8. Add Drizzle relations: projects (user, project_documents, project_links, project_milestones, project_tasks); project_milestones.tasks (many project_tasks), project_tasks.milestone (one project_milestones); update user relations and conversation/agentExecution relations to include project where applicable.
</action>
</task>

</tasks>

<verification>
- Run existing DB migration or generate migration; schema builds without error.
- All new tables and columns appear in schema.ts with correct types and FKs.
</verification>
