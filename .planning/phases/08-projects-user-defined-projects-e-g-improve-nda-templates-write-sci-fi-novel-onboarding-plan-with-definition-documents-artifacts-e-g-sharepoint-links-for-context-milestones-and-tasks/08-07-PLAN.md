---
phase: 08-projects
plan: 07
type: execute
wave: 2
depends_on: ["08-05", "08-06"]
files_modified:
  - apps/server/src/db/schema.ts
  - apps/server/src/trpc/router.ts
  - apps/server/src/coaching/chat-route.ts
  - apps/server/src/coaching/system-prompt.ts
  - apps/web/src/app/[locale]/(app)/projects/[id]/page.tsx
  - apps/web/src/hooks/use-coaching-chat.ts
  - apps/web/messages/en.json
autonomous: true

must_haves:
  truths:
    - "Documents and links can be attached at the milestone (section) level, not just project level"
    - "Each milestone can have its own separate chat thread scoped to that section's context"
    - "When chatting in a milestone-scoped thread, the system prompt narrows to that milestone's docs/links only"
    - "Conversations table has optional milestoneId for section-level scoping"
  artifacts:
    - path: "apps/server/src/db/schema.ts"
      provides: "milestoneId on project_documents, project_links, and conversations"
      contains: "milestoneId"
    - path: "apps/server/src/trpc/router.ts"
      provides: "milestoneId parameter on addDocument, addLink; milestone-filtered queries; getOrCreateProjectThread for distinct conversation per project/section"
      contains: "milestoneId"
    - path: "apps/server/src/coaching/chat-route.ts"
      provides: "loadProjectContext accepts milestoneId and narrows to section docs/links"
      contains: "milestoneId"
    - path: "apps/web/src/app/[locale]/(app)/projects/[id]/page.tsx"
      provides: "Open chat button per milestone, section-level doc/link attachment UI"
      contains: "milestoneId"
  key_links:
    - from: "apps/web/src/app/[locale]/(app)/projects/[id]/page.tsx"
      to: "/chat?projectId=xxx&milestoneId=yyy"
      via: "Open chat link on each milestone"
      pattern: "milestoneId"
    - from: "apps/web/src/app/[locale]/(app)/chat/page.tsx"
      to: "conversation.getOrCreateProjectThread"
      via: "When projectId in URL, get-or-create conversation scoped to (projectId, milestoneId); each section has its own thread"
      pattern: "getOrCreateProjectThread"
    - from: "apps/server/src/trpc/router.ts"
      to: "conversations table"
      via: "getOrCreateProjectThread finds or creates conversation by userId + projectId + milestoneId so project-level and section-level chats are separate conversations"
      pattern: "getOrCreateProjectThread"
    - from: "apps/server/src/coaching/chat-route.ts"
      to: "apps/server/src/db/schema.ts"
      via: "loadProjectContext filters docs/links by milestoneId when present"
      pattern: "milestoneId"
    - from: "apps/web/src/hooks/use-coaching-chat.ts"
      to: "apps/server/src/coaching/chat-route.ts"
      via: "milestoneId in request body"
      pattern: "milestoneId"
---

<objective>
Add section-level context and section-level chat threads. Documents and links can attach to specific milestones (sections), and each milestone can open its own chat thread scoped to that section's context.

Purpose: Per locked decisions: "Context can be attached at both project level AND section level" and "Each section can have its own separate chat thread, automatically scoped to that section's context." This is the key LLM context strategy -- chatting about one chapter shouldn't load the entire book.

Output: milestoneId on project_documents, project_links, conversations; section-level doc/link attachment UI; "Open chat" per milestone; chat route narrows context when milestoneId present.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-projects-user-defined-projects-e-g-improve-nda-templates-write-sci-fi-novel-onboarding-plan-with-definition-documents-artifacts-e-g-sharepoint-links-for-context-milestones-and-tasks/08-01-SUMMARY.md
@.planning/phases/08-projects-user-defined-projects-e-g-improve-nda-templates-write-sci-fi-novel-onboarding-plan-with-definition-documents-artifacts-e-g-sharepoint-links-for-context-milestones-and-tasks/08-02-SUMMARY.md
@.planning/phases/08-projects-user-defined-projects-e-g-improve-nda-templates-write-sci-fi-novel-onboarding-plan-with-definition-documents-artifacts-e-g-sharepoint-links-for-context-milestones-and-tasks/08-03-SUMMARY.md

@apps/server/src/coaching/chat-route.ts (for loadProjectContext)
@apps/web/src/hooks/use-coaching-chat.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add milestoneId to project_documents, project_links, and conversations; update tRPC and chat route</name>
  <files>apps/server/src/db/schema.ts, apps/server/src/trpc/router.ts, apps/server/src/coaching/chat-route.ts, apps/server/src/coaching/system-prompt.ts</files>
  <action>
1. In `apps/server/src/db/schema.ts`:
   - Add to `projectDocuments`: `milestoneId: uuid("milestone_id").references(() => projectMilestones.id, { onDelete: "set null" })`
   - Add to `projectLinks`: `milestoneId: uuid("milestone_id").references(() => projectMilestones.id, { onDelete: "set null" })`
   - Add to `conversations`: `milestoneId: uuid("milestone_id").references((): AnyPgColumn => projectMilestones.id, { onDelete: "set null" })` (use AnyPgColumn since projectMilestones may be defined after conversations; add index `conversations_milestoneId_idx`)
   - Update Drizzle relations as needed (projectDocuments -> milestone, projectLinks -> milestone, conversation -> milestone)

2. Run `npx drizzle-kit generate` for migration.

3. In `apps/server/src/trpc/router.ts`:
   - Update `project.addDocument`: add optional `milestoneId: z.string().uuid().nullable().optional()` input. If provided, validate milestone belongs to the project. Include milestoneId in insert.
   - Update `project.addLink`: add optional `milestoneId: z.string().uuid().nullable().optional()` input. If provided, validate milestone belongs to the project. Include milestoneId in insert (alongside the linkType from 08-06).
   - Update `project.get`: when returning documents and links, include milestoneId so the UI can group them.

4. In `apps/server/src/coaching/chat-route.ts`:
   - Accept optional `milestoneId` in the request body alongside projectId: `milestoneId?: string`
   - Update `loadProjectContext(projectId, userId, milestoneId?)`:
     - When milestoneId is provided:
       - Load the milestone title (for context string)
       - Filter project_documents to only those where milestoneId matches OR milestoneId IS NULL (project-level docs are always included)
       - Filter project_links similarly
       - Include "Section: {milestone.title}" in the context string
     - When milestoneId is NOT provided: current behavior (all docs and links for the project)
   - Store milestoneId on new conversation creation (alongside projectId)
   - Use conversation's milestoneId (with fallback to body milestoneId) for agent executions context

5. In `apps/server/src/coaching/system-prompt.ts`:
   - No changes needed -- projectContext is already a string built by loadProjectContext; the narrowing happens in chat-route.ts
  </action>
  <verify>
   - `npx tsc --noEmit` passes
   - Migration file exists for new milestoneId columns
   - addDocument with milestoneId stores it correctly
   - addLink with milestoneId stores it correctly
   - loadProjectContext with milestoneId narrows to section docs + project-level docs
   - loadProjectContext without milestoneId returns all docs/links (backward compatible)
  </verify>
  <done>milestoneId exists on project_documents, project_links, and conversations; tRPC accepts milestoneId for doc/link attachment; chat route narrows context to section when milestoneId is present</done>
</task>

<task type="auto">
  <name>Task 2: Add section-level doc/link attachment and per-milestone "Open chat" in project detail UI</name>
  <files>apps/web/src/app/[locale]/(app)/projects/[id]/page.tsx, apps/web/src/hooks/use-coaching-chat.ts, apps/web/messages/en.json</files>
  <action>
1. In `apps/web/messages/en.json`, add to "projects" namespace:
   - `"openChatForSection": "Chat about this section"`, `"sectionDocs": "Section documents"`, `"sectionLinks": "Section links"`, `"attachDocToSection": "Attach doc to section..."`, `"addLinkToSection": "Add link to section"`

2. In `apps/web/src/hooks/use-coaching-chat.ts`:
   - Add optional `milestoneId?: string | null` parameter (5th param)
   - Include milestoneId in the body when provided: `body: { chatId, mode, ...(projectId ? { projectId } : {}), ...(milestoneId ? { milestoneId } : {}) }`

3. In `apps/web/src/app/[locale]/(app)/projects/[id]/page.tsx`:
   - In each milestone's rendered block, add below the milestone header:
     a. **"Chat about this section" button**: links to `/chat?projectId=${id}&milestoneId=${m.id}` -- same pattern as the project-level Open chat but includes milestoneId in the URL
     b. **Section documents**: show documents where milestoneId === m.id. Add an attach dropdown (filtered to available docs) that calls `addDocument.mutate({ projectId: id, documentId, milestoneId: m.id })`. Show a compact list with remove button.
     c. **Section links**: show links where milestoneId === m.id. Add a small "add link to section" form that calls `addLink.mutate({ projectId: id, url, label, milestoneId: m.id })`. Show compact list with typed icons (use getLinkIcon from 08-06) and remove button.
   - Group display: project-level docs/links (milestoneId is null) in the existing Documents & Links card; section-level docs/links (milestoneId matches) inline within each milestone
   - The project-level "Open chat for this project" button remains as-is (no milestoneId)

4. Update the chat page to read milestoneId from searchParams and pass it to useCoachingChat:
   - In `apps/web/src/app/[locale]/(app)/chat/[id]/page.tsx` and `apps/web/src/app/[locale]/(app)/chat/page.tsx`:
     - Read `milestoneId` from searchParams (same pattern as projectId)
     - Pass to useCoachingChat as the 5th argument
     - Preserve milestoneId in redirect URLs
  </action>
  <verify>
   - `npx tsc --noEmit` passes
   - Each milestone shows "Chat about this section" button with correct URL
   - Documents can be attached to a specific milestone
   - Links can be added to a specific milestone with typed icons
   - Chat opened from a milestone includes milestoneId in the request
  </verify>
  <done>Each milestone in the project detail page has section-level doc/link attachment, a "Chat about this section" button, and the chat route receives milestoneId to narrow context</done>
</task>

</tasks>

<verification>
1. Create a project with 2 milestones. Attach doc "A" at project level. Attach doc "B" to milestone 1 only.
2. Open chat from project level -- verify system prompt includes both doc A and B
3. Open chat from milestone 1 -- verify system prompt includes doc A (project-level) and doc B (section-level), but NOT docs attached to milestone 2
4. Add a link to milestone 2 -- verify it shows only under milestone 2, not at project level
5. Open chat from milestone 2 -- verify context includes doc A (project-level) + milestone 2's link, but NOT milestone 1's doc B
</verification>

<success_criteria>
- Documents and links can be attached at both project and milestone level
- Each milestone has "Chat about this section" button
- Section-scoped chat narrows context to section docs/links + project-level docs/links
- Project-level chat still includes all docs/links (backward compatible)
- milestoneId stored on conversations for section-level threads
</success_criteria>

<output>
After completion, create `.planning/phases/08-projects-user-defined-projects-e-g-improve-nda-templates-write-sci-fi-novel-onboarding-plan-with-definition-documents-artifacts-e-g-sharepoint-links-for-context-milestones-and-tasks/08-07-SUMMARY.md`
</output>
