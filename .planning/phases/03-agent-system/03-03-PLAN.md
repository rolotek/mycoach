---
phase: 03-agent-system
plan: "03"
type: execute
wave: 3
depends_on: ["03-01", "03-02"]
files_modified:
  - apps/web/src/app/(app)/agents/page.tsx
  - apps/web/src/app/(app)/chat/components/agent-approval.tsx
  - apps/web/src/app/(app)/chat/components/agent-result.tsx
  - apps/web/src/app/(app)/chat/components/message-list.tsx
  - apps/web/src/hooks/use-coaching-chat.ts
  - apps/web/src/app/(app)/dashboard/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can view their agent library on the /agents page"
    - "User can create a new agent with name, description, and system prompt"
    - "User can edit and delete existing agents"
    - "In chat, user sees an approval card when chief-of-staff suggests routing to an agent"
    - "User can approve or deny the agent dispatch from the approval card"
    - "After approval, agent result appears as a distinct card in the chat"
    - "Dashboard links to agents page"
  artifacts:
    - path: "apps/web/src/app/(app)/agents/page.tsx"
      provides: "Agent management UI with list, create, edit, delete"
      min_lines: 60
    - path: "apps/web/src/app/(app)/chat/components/agent-approval.tsx"
      provides: "Approval card component with approve/deny buttons"
      exports: ["AgentApprovalCard"]
    - path: "apps/web/src/app/(app)/chat/components/agent-result.tsx"
      provides: "Agent result card component showing structured output"
      exports: ["AgentResultCard"]
    - path: "apps/web/src/app/(app)/chat/components/message-list.tsx"
      provides: "Updated message list rendering tool parts for approval and results"
      contains: "dispatch_"
    - path: "apps/web/src/hooks/use-coaching-chat.ts"
      provides: "Updated hook with sendAutomaticallyWhen for approval flow"
      contains: "sendAutomaticallyWhen"
  key_links:
    - from: "apps/web/src/app/(app)/agents/page.tsx"
      to: "trpc.agent.*"
      via: "tRPC calls for CRUD operations"
      pattern: "trpc\\.agent\\."
    - from: "apps/web/src/app/(app)/chat/components/message-list.tsx"
      to: "apps/web/src/app/(app)/chat/components/agent-approval.tsx"
      via: "renders AgentApprovalCard for approval-requested tool parts"
      pattern: "AgentApprovalCard"
    - from: "apps/web/src/hooks/use-coaching-chat.ts"
      to: "addToolApprovalResponse"
      via: "returned from useChat for approval flow"
      pattern: "addToolApprovalResponse"
---

<objective>
Build the agent management page and integrate agent approval/result rendering into the existing chat UI.

Purpose: AGENT-01 (create agents via UI), AGENT-02 (see starter templates), AGENT-03 (approve/deny in chat), and AGENT-04 (see results in chat) all need frontend components. This completes the Phase 3 user experience.
Output: /agents page with CRUD, approval card in chat, result card in chat, updated useCoachingChat hook, dashboard link.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-agent-system/03-RESEARCH.md
@.planning/phases/03-agent-system/03-01-SUMMARY.md
@.planning/phases/03-agent-system/03-02-SUMMARY.md
@apps/web/src/hooks/use-coaching-chat.ts
@apps/web/src/app/(app)/chat/components/message-list.tsx
@apps/web/src/app/(app)/chat/[id]/page.tsx
@apps/web/src/app/(app)/dashboard/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Agent management page</name>
  <files>apps/web/src/app/(app)/agents/page.tsx, apps/web/src/app/(app)/dashboard/page.tsx</files>
  <action>
  1. Create `apps/web/src/app/(app)/agents/page.tsx`:

  A full agent management page following the existing patterns in the memory and documents pages.

  **Layout:** Page title "Agents", subtitle "Your specialist agent library", a "Create Agent" button at top right.

  **Agent list:** Call `trpc.agent.list.useQuery()`. Display agents in a card grid (2 columns on large screens, 1 on mobile). Each card shows:
  - Agent name (bold) with icon if present
  - Description (1-2 lines, truncated)
  - "Starter" badge if isStarter is true
  - Edit and Delete buttons (small, bottom of card)

  **Create/Edit form:** A modal or inline form with:
  - Name input (required, max 100)
  - Description textarea (required, max 500)
  - System prompt textarea (required, larger)
  - Icon text input (optional, for emoji)
  - Save button calls `trpc.agent.create.mutate()` for new or `trpc.agent.update.mutate()` for edit
  - After save, invalidate agent.list query
  - Use React state for form visibility and editing agent id

  **Delete:** Confirm dialog before calling `trpc.agent.delete.mutate()`. Invalidate agent.list after success.

  Follow existing Tailwind patterns: neutral color palette, rounded-lg, borders, hover states. Match the styling of the memory and documents pages.

  2. Update `apps/web/src/app/(app)/dashboard/page.tsx`:
  - Add a link card for "Agents" pointing to /agents, with a brief description like "Manage your specialist agents"
  - Place it alongside existing links (chat, memory, documents, settings)
  </action>
  <verify>
  - `cd apps/web && npx next build` completes (or `npx tsc --noEmit`)
  - Navigate to /agents page and see starter templates (after first load triggers seeding via tRPC)
  </verify>
  <done>Agents page at /agents shows agent list with create/edit/delete capabilities. Dashboard links to agents page. Starter templates appear on first visit.</done>
</task>

<task type="auto">
  <name>Task 2: Chat approval and result components + useCoachingChat update</name>
  <files>apps/web/src/app/(app)/chat/components/agent-approval.tsx, apps/web/src/app/(app)/chat/components/agent-result.tsx, apps/web/src/app/(app)/chat/components/message-list.tsx, apps/web/src/hooks/use-coaching-chat.ts</files>
  <action>
  1. Create `apps/web/src/app/(app)/chat/components/agent-approval.tsx`:

  Export `AgentApprovalCard` component with props: `{ agentName: string, task: string, onApprove: () => void, onDeny: () => void }`.
  - Render a distinct card (blue/indigo border or background to differentiate from regular messages)
  - Show: "Chief of Staff suggests: Delegate to {agentName}" as the header
  - Show the task description below
  - Two buttons: "Approve" (primary/green) and "Deny" (secondary/gray)
  - After clicking, buttons should be disabled or replaced with status text

  2. Create `apps/web/src/app/(app)/chat/components/agent-result.tsx`:

  Export `AgentResultCard` component with props: `{ agentName: string, result: string }`.
  - Render a distinct card (green border or background)
  - Show: "Result from {agentName}" as the header
  - Show the result text with markdown rendering (reuse the renderMarkdown helper from message-list or extract it to a shared util)
  - Visually distinct from regular assistant messages so user knows it came from a specialist agent

  Also export `AgentDeniedCard` component with no props (or minimal props):
  - Small muted card showing "Agent dispatch was declined"

  3. Update `apps/web/src/app/(app)/chat/components/message-list.tsx`:

  The message list currently only renders text parts. Update it to also render tool parts:

  For each message, iterate over `m.parts`. For each part:
  - If `part.type === "text"`: render as before (the text content)
  - If `part.type === "tool-invocation"` (this is how AI SDK represents tool parts in UIMessage):
    - Check if `part.toolName` starts with `"dispatch_"` (agent dispatch tool)
    - Based on `part.state`:
      - `"partial-call"` or `"call"`: show a "Routing..." indicator
      - `"result"`: render `<AgentResultCard agentName={extractAgentName(part.toolName)} result={part.result?.result || part.result} />`
    - For approval-requested state: this is rendered via a separate mechanism by useChat -- the tool parts with `needsApproval` appear with an `approval` property. Check the AI SDK UIMessage type for the exact shape. If `part.state === "call"` and the part has a pending approval, render `<AgentApprovalCard>` with onApprove/onDeny wired to `addToolApprovalResponse`.
  - For non-dispatch tool invocations (the existing task mode tools like createActionItems): render the tool result as structured content (this may already be handled or can be a simple JSON display)

  Import `AgentApprovalCard` and `AgentResultCard`. The `addToolApprovalResponse` function needs to be passed down from the parent page component (via props or context).

  Update the component props to accept `addToolApprovalResponse` as an optional function prop. Update the chat page (`[id]/page.tsx`) to pass it down from useCoachingChat.

  Helper function `extractAgentName(toolName: string)`: take "dispatch_contract_attorney" -> "Contract Attorney" by removing "dispatch_" prefix, replacing hyphens/underscores with spaces, and title-casing.

  4. Update `apps/web/src/hooks/use-coaching-chat.ts`:

  Import `lastAssistantMessageIsCompleteWithApprovalResponses` from "ai" (if available; check AI SDK exports -- if not available, this may be a different import path or named differently).

  Update the useChat call to include:
  - `sendAutomaticallyWhen: lastAssistantMessageIsCompleteWithApprovalResponses` -- this auto-sends the next request after the user approves/denies all pending tool approvals, continuing the agent loop

  Return `addToolApprovalResponse` from the hook (it's returned by useChat when tools have needsApproval).

  5. Update `apps/web/src/app/(app)/chat/[id]/page.tsx`:
  - Destructure `addToolApprovalResponse` from `useCoachingChat`
  - Pass it to `<MessageList>` as a prop
  </action>
  <verify>
  - `cd apps/web && npx tsc --noEmit` or `npx next build` compiles
  - Start both server and web, navigate to /chat, send a task-like message (e.g., "Draft an email to my team about our Q1 goals"), observe that an approval card appears
  </verify>
  <done>Chat displays agent approval cards with approve/deny for dispatch suggestions. After approval, agent result appears as a distinct card. After deny, a declined message appears. useCoachingChat auto-continues after approval responses. MessageList handles both text and tool-invocation parts.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: End-to-end agent system verification</name>
  <files>none</files>
  <action>
  Present the following verification checklist to the user. The user must manually test each step since these involve visual UI checks and interactive LLM-driven flows that cannot be verified programmatically.
  </action>
  <verify>
  User completes all 10 verification steps:
  1. Navigate to /agents -- verify 4 starter templates appear (contract attorney, comms writer, meeting prep, research analyst)
  2. Create a new custom agent with a name, description, and system prompt -- verify it appears in the list
  3. Edit the custom agent -- verify changes persist
  4. Delete the custom agent -- verify it disappears
  5. Navigate to /chat and start a new conversation
  6. Send a coaching question: "Help me think through whether to take this new job offer" -- verify the coach responds directly WITHOUT suggesting an agent
  7. Send a task request: "Draft an email to my team announcing our Q1 priorities" -- verify an approval card appears suggesting the Comms Writer agent
  8. Click "Approve" on the approval card -- verify the agent executes and a result card appears with the drafted email
  9. Send another task: "Review this contract clause: The vendor may terminate at any time with 30 days notice" -- verify Contract Attorney is suggested
  10. Click "Deny" -- verify a declined message appears and the coach acknowledges the denial
  </verify>
  <done>All 10 verification steps pass. Phase 3 requirements AGENT-01 through AGENT-04 are satisfied.</done>
  <what-built>Complete agent system: agent management page with CRUD, chief-of-staff routing with suggest-then-confirm, specialist agent execution with results in chat, starter templates.</what-built>
  <how-to-verify>
  1. Navigate to /agents -- verify 4 starter templates appear (contract attorney, comms writer, meeting prep, research analyst)
  2. Create a new custom agent with a name, description, and system prompt -- verify it appears in the list
  3. Edit the custom agent -- verify changes persist
  4. Delete the custom agent -- verify it disappears
  5. Navigate to /chat and start a new conversation
  6. Send a coaching question: "Help me think through whether to take this new job offer" -- verify the coach responds directly WITHOUT suggesting an agent
  7. Send a task request: "Draft an email to my team announcing our Q1 priorities" -- verify an approval card appears suggesting the Comms Writer agent
  8. Click "Approve" on the approval card -- verify the agent executes and a result card appears with the drafted email
  9. Send another task: "Review this contract clause: The vendor may terminate at any time with 30 days notice" -- verify Contract Attorney is suggested
  10. Click "Deny" -- verify a declined message appears and the coach acknowledges the denial
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- /agents page loads and shows agent list with CRUD operations
- /chat displays approval cards for agent dispatch suggestions
- Approve flow: approval card -> agent execution -> result card in chat
- Deny flow: approval card -> denied message -> coach acknowledges
- Coaching questions: coach responds directly without agent suggestion
- Dashboard includes link to agents page
</verification>

<success_criteria>
- AGENT-01: User creates specialist agent via /agents page with name, description, prompt
- AGENT-02: 4 starter templates visible on /agents on first visit
- AGENT-03: Chief-of-staff suggests agent in chat, user approves/denies before dispatch
- AGENT-04: Agent results appear as structured cards in the chat conversation
</success_criteria>

<output>
After completion, create `.planning/phases/03-agent-system/03-03-SUMMARY.md`
</output>
