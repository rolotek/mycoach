---
phase: 03-agent-system
plan: "01"
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/server/src/db/schema.ts
  - apps/server/src/agents/templates.ts
  - apps/server/src/trpc/router.ts
autonomous: true

must_haves:
  truths:
    - "User can create a specialist agent by providing name, description, and system prompt"
    - "User can list, update, and delete their agents"
    - "Starter agent templates exist for each user on first access"
    - "Each user sees only their own agents"
  artifacts:
    - path: "apps/server/src/db/schema.ts"
      provides: "agents and agentExecutions table definitions with relations"
      contains: "agents"
    - path: "apps/server/src/agents/templates.ts"
      provides: "4 starter agent templates and lazy seeding function"
      exports: ["STARTER_TEMPLATES", "seedStarterAgents"]
    - path: "apps/server/src/trpc/router.ts"
      provides: "agentRouter with list, create, update, delete procedures"
      contains: "agentRouter"
  key_links:
    - from: "apps/server/src/trpc/router.ts"
      to: "apps/server/src/db/schema.ts"
      via: "import agents table"
      pattern: "import.*agents.*from.*schema"
    - from: "apps/server/src/trpc/router.ts"
      to: "apps/server/src/agents/templates.ts"
      via: "seedStarterAgents called in agent.list"
      pattern: "seedStarterAgents"
---

<objective>
Add the agents and agentExecutions database tables, tRPC CRUD router for agent management, and starter template seeding logic.

Purpose: AGENT-01 (create agents) and AGENT-02 (starter templates) require persistent agent storage and API operations. This plan builds the data layer that Plan 02 (chief-of-staff) and Plan 03 (UI) depend on.
Output: DB schema with agents + agentExecutions tables, tRPC agentRouter, 4 starter templates with lazy seeding.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-agent-system/03-RESEARCH.md
@apps/server/src/db/schema.ts
@apps/server/src/trpc/router.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Agent DB schema and starter templates</name>
  <files>apps/server/src/db/schema.ts, apps/server/src/agents/templates.ts</files>
  <action>
  1. In `apps/server/src/db/schema.ts`, add two new tables after the existing userFacts table:

  **agents table:**
  - id: uuid PK defaultRandom
  - userId: text, NOT NULL, references user.id with onDelete cascade
  - name: text NOT NULL
  - slug: text NOT NULL
  - description: text NOT NULL
  - systemPrompt: text("system_prompt") NOT NULL
  - isStarter: boolean("is_starter") default false NOT NULL
  - icon: text (nullable)
  - createdAt: timestamp defaultNow NOT NULL
  - updatedAt: timestamp defaultNow NOT NULL
  - Indexes: agents_userId_idx on userId, unique index agents_userId_slug_idx on (userId, slug) to prevent duplicate slugs per user

  **agentExecutions table:**
  - id: uuid PK defaultRandom
  - userId: text NOT NULL, references user.id cascade
  - agentId: uuid NOT NULL, references agents.id cascade
  - conversationId: uuid, references conversations.id set null
  - task: text NOT NULL
  - result: text (nullable)
  - status: text default "pending" NOT NULL (values: pending, running, completed, failed, denied)
  - createdAt: timestamp defaultNow NOT NULL
  - completedAt: timestamp (nullable)
  - Indexes: on userId, on agentId

  Add relations:
  - agentRelations: agent belongs to user (userId -> user.id)
  - agentExecutionRelations: execution belongs to user, agent, optionally conversation
  - Update userRelations to add `agents: many(agents)`

  2. Create `apps/server/src/agents/templates.ts`:
  - Export `STARTER_TEMPLATES` array with 4 objects: contract-attorney, comms-writer, meeting-prep, research-analyst. Each has: name, slug, description, systemPrompt, icon. Use the exact prompts from 03-RESEARCH.md.
  - Export `async function seedStarterAgents(db, userId)` that:
    a. Checks if user has ANY agents: `SELECT count(*) FROM agents WHERE userId = ?`
    b. If count > 0, return early (already seeded or user has custom agents)
    c. If count === 0, insert all 4 templates with `isStarter: true` and the user's userId
    d. Return the inserted agents

  3. Run `npx drizzle-kit push` from the server directory to apply schema changes to the database.
  </action>
  <verify>
  - `npx drizzle-kit push` completes without errors
  - TypeScript compiles: `cd apps/server && npx tsc --noEmit`
  </verify>
  <done>agents and agentExecutions tables exist in DB schema with proper indexes and relations. STARTER_TEMPLATES array and seedStarterAgents function exported from templates.ts.</done>
</task>

<task type="auto">
  <name>Task 2: tRPC agent router with lazy seeding</name>
  <files>apps/server/src/trpc/router.ts</files>
  <action>
  Add an `agentRouter` to `apps/server/src/trpc/router.ts` following the exact patterns of the existing conversationRouter and documentRouter.

  Import the `agents` and `agentExecutions` tables from schema, and `seedStarterAgents` from `../agents/templates`.

  **agent.list** (protectedProcedure.query):
  - Call `await seedStarterAgents(ctx.db, ctx.user.id)` first (lazy seeding -- only inserts on first access when user has 0 agents)
  - Then return `db.select().from(agents).where(eq(agents.userId, ctx.user.id)).orderBy(agents.name)`

  **agent.create** (protectedProcedure.input().mutation):
  - Input: z.object({ name: z.string().min(1).max(100), description: z.string().min(1).max(500), systemPrompt: z.string().min(1), icon: z.string().optional() })
  - Generate slug: `name.toLowerCase().replace(/\s+/g, "-").replace(/[^a-z0-9-]/g, "")`
  - Insert into agents table with userId, name, slug, description, systemPrompt, icon, isStarter: false
  - Handle unique slug conflict: if insert fails on unique constraint, append `-${Date.now()}` suffix and retry once
  - Return the inserted row

  **agent.update** (protectedProcedure.input().mutation):
  - Input: z.object({ id: z.string().uuid(), name, description, systemPrompt, icon -- all optional except id })
  - If name is provided, regenerate slug
  - Update with `updatedAt: new Date()`, scoped to userId
  - Throw NOT_FOUND if no row returned
  - Return updated row

  **agent.delete** (protectedProcedure.input().mutation):
  - Input: z.object({ id: z.string().uuid() })
  - Delete from agents where id AND userId match
  - Return { success: true }

  Add `agent: agentRouter` to the appRouter.
  </action>
  <verify>
  - TypeScript compiles: `cd apps/server && npx tsc --noEmit`
  - Server starts without errors: start the server and hit /health
  </verify>
  <done>tRPC agent.list (with lazy seeding), agent.create (with slug generation), agent.update, and agent.delete all available on the appRouter. First call to agent.list for a new user seeds 4 starter templates.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes in apps/server
- Database has agents and agent_executions tables (verify with drizzle-kit push output)
- Server starts and /health returns 200
</verification>

<success_criteria>
- agents and agentExecutions tables in schema with proper FK constraints and indexes
- 4 starter templates defined in templates.ts
- tRPC agentRouter with list/create/update/delete procedures
- Lazy seeding: first agent.list call for a user inserts starter templates
- All operations scoped to authenticated user's userId
</success_criteria>

<output>
After completion, create `.planning/phases/03-agent-system/03-01-SUMMARY.md`
</output>
