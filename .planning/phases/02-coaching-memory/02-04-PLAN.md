---
phase: 02-coaching-memory
plan: "04"
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - apps/web/src/hooks/use-coaching-chat.ts
  - apps/web/src/app/(app)/chat/page.tsx
  - apps/web/src/app/(app)/chat/[id]/page.tsx
  - apps/web/src/app/(app)/chat/components/message-list.tsx
  - apps/web/src/app/(app)/chat/components/chat-input.tsx
  - apps/web/src/app/(app)/chat/components/mode-toggle.tsx
  - apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx
  - apps/web/src/app/(app)/memory/page.tsx
  - apps/web/src/app/(app)/documents/page.tsx
  - apps/web/src/app/(app)/dashboard/page.tsx
  - apps/web/package.json
autonomous: false

must_haves:
  truths:
    - "User can start a new chat conversation and see streaming responses from the coach"
    - "User can switch between conversations via a sidebar"
    - "User can toggle between coaching mode and task mode"
    - "User can upload documents and see them in a documents list"
    - "User can view, edit, and delete facts the system knows about them"
    - "Chat messages persist across page refreshes"
    - "Dashboard links to chat, memory, and documents pages"
  artifacts:
    - path: "apps/web/src/hooks/use-coaching-chat.ts"
      provides: "Wrapper around useChat with DefaultChatTransport configured for the server"
      exports: ["useCoachingChat"]
    - path: "apps/web/src/app/(app)/chat/page.tsx"
      provides: "New conversation page that creates a conversation and redirects"
    - path: "apps/web/src/app/(app)/chat/[id]/page.tsx"
      provides: "Chat interface with message list, input, mode toggle, and sidebar"
    - path: "apps/web/src/app/(app)/chat/components/message-list.tsx"
      provides: "Renders chat messages with support for markdown and structured output"
    - path: "apps/web/src/app/(app)/chat/components/chat-input.tsx"
      provides: "Text input with send button for composing messages"
    - path: "apps/web/src/app/(app)/chat/components/mode-toggle.tsx"
      provides: "Toggle between auto/coaching/task modes"
    - path: "apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx"
      provides: "List of user conversations with create new and delete"
    - path: "apps/web/src/app/(app)/memory/page.tsx"
      provides: "View, edit, and delete user facts"
    - path: "apps/web/src/app/(app)/documents/page.tsx"
      provides: "Upload and manage documents"
  key_links:
    - from: "apps/web/src/hooks/use-coaching-chat.ts"
      to: "/api/chat"
      via: "DefaultChatTransport with credentials include"
      pattern: "DefaultChatTransport.*api/chat"
    - from: "apps/web/src/app/(app)/chat/[id]/page.tsx"
      to: "apps/web/src/hooks/use-coaching-chat.ts"
      via: "useCoachingChat hook"
      pattern: "useCoachingChat"
    - from: "apps/web/src/app/(app)/memory/page.tsx"
      to: "trpc.userFact"
      via: "tRPC queries for user facts"
      pattern: "trpc\\.userFact"
    - from: "apps/web/src/app/(app)/documents/page.tsx"
      to: "/api/documents/upload"
      via: "fetch POST with FormData"
      pattern: "api/documents/upload"
---

<objective>
Build the chat interface with streaming messages, conversation management, mode toggling, and the memory/documents management pages.

Purpose: This is the user-facing layer for all Phase 2 features. It connects the streaming chat engine (02-02) and CRUD operations (02-03) to a usable interface. Covers the UI for COACH-01 (chat), COACH-03 (structured output display), COACH-05 (mode toggle), MEM-02 (document upload UI), and MEM-04 (fact management).
Output: Chat pages, memory page, documents page, updated dashboard.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-coaching-memory/02-RESEARCH.md
@.planning/phases/02-coaching-memory/02-02-SUMMARY.md
@.planning/phases/02-coaching-memory/02-03-SUMMARY.md

@apps/web/src/app/(app)/layout.tsx
@apps/web/src/app/(app)/dashboard/page.tsx
@apps/web/src/lib/trpc.ts
@apps/web/src/lib/auth-client.ts
@apps/web/src/providers/index.tsx
@apps/web/package.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build chat interface with streaming, sidebar, and mode toggle</name>
  <files>
    apps/web/src/hooks/use-coaching-chat.ts
    apps/web/src/app/(app)/chat/page.tsx
    apps/web/src/app/(app)/chat/[id]/page.tsx
    apps/web/src/app/(app)/chat/components/message-list.tsx
    apps/web/src/app/(app)/chat/components/chat-input.tsx
    apps/web/src/app/(app)/chat/components/mode-toggle.tsx
    apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx
    apps/web/src/app/(app)/dashboard/page.tsx
    apps/web/package.json
  </files>
  <action>
**1. Install dependencies:**

```bash
cd apps/web && npm install @ai-sdk/react ai
```

The web app needs `@ai-sdk/react` for `useChat` and `ai` for `DefaultChatTransport`.

**2. Create `apps/web/src/hooks/use-coaching-chat.ts`:**

```typescript
"use client";
import { useChat } from "@ai-sdk/react";
import { DefaultChatTransport } from "ai";

const SERVER_URL = process.env.NEXT_PUBLIC_SERVER_URL || "http://localhost:3001";

export function useCoachingChat(chatId: string, mode: string = "auto") {
  return useChat({
    id: chatId,
    transport: new DefaultChatTransport({
      api: `${SERVER_URL}/api/chat`,
      credentials: "include",
      body: { chatId, mode },
    }),
  });
}
```

Note: `useChat` from `@ai-sdk/react` v3.x uses the transport-based architecture. The `body` option sends extra fields (chatId, mode) with each request. `credentials: "include"` sends the auth cookie.

**3. Create `apps/web/src/app/(app)/chat/components/message-list.tsx`:**

A "use client" component that renders an array of messages:
- Each message shows role (User/Coach) and content
- User messages: right-aligned, blue background
- Assistant messages: left-aligned, white/gray background
- Support for markdown rendering (simple: convert line breaks to `<br>`, bold with `**`, lists with `-`)
- Show a typing indicator when `status === "streaming"`
- Auto-scroll to bottom on new messages (use a ref + useEffect)
- Empty state: "Start a conversation with your coach"

Props: `messages: UIMessage[]`, `status: string`

**4. Create `apps/web/src/app/(app)/chat/components/chat-input.tsx`:**

A "use client" component with:
- A textarea (auto-grows, max 5 rows)
- Send button (disabled when empty or when status is "streaming")
- Submit on Enter (but Shift+Enter for newline)
- Props: `input: string`, `handleInputChange`, `handleSubmit`, `status: string`

**5. Create `apps/web/src/app/(app)/chat/components/mode-toggle.tsx`:**

A "use client" component that shows three mode buttons:
- Auto (default), Coaching, Task
- Highlights the active mode
- Calls an onChange callback when switched
- Props: `mode: string`, `onChange: (mode: string) => void`

**6. Create `apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx`:**

A "use client" component that lists conversations:
- Uses tRPC `conversation.list` to fetch conversations
- Shows conversation title (or "New conversation" if no title) and relative date
- Highlights the active conversation
- "New Chat" button at the top
- Delete button on each conversation (with confirmation)
- Props: `activeChatId: string`
- On "New Chat", redirect to /chat (which creates a new conversation)
- On conversation click, navigate to /chat/[id]

**7. Create `apps/web/src/app/(app)/chat/page.tsx`:**

A page that creates a new conversation and redirects to /chat/[id]:
- Uses tRPC `conversation.create` mutation
- On mount (useEffect), creates a conversation and redirects via router.replace
- Shows a loading state while creating

**8. Create `apps/web/src/app/(app)/chat/[id]/page.tsx`:**

The main chat page combining all components:
- Layout: sidebar on left (hidden on mobile, toggle button), main chat area on right
- Uses `useCoachingChat(chatId, mode)` for streaming chat
- Mode toggle at top of chat area
- Message list in scrollable center
- Chat input at bottom
- On page load, fetch existing messages via tRPC `conversation.get` and set as initial messages
- The chatId comes from the URL params
- State: mode (default "auto"), sidebar visible toggle

For loading initial messages, use tRPC `conversation.get` and pass the messages to useChat via the `initialMessages` option. Since useChat may not support setting initialMessages after mount, load messages first then render the chat hook.

**9. Update `apps/web/src/app/(app)/dashboard/page.tsx`:**

Add navigation links to:
- `/chat` — "Start Coaching Session"
- `/memory` — "Memory & Knowledge"
- `/documents` — "Documents"

Keep existing "Settings" and "Sign out" functionality.
  </action>
  <verify>
1. `cd apps/web && npx tsc --noEmit` — no type errors
2. Navigate to /chat — creates new conversation and redirects
3. Navigate to /chat/[id] — shows chat interface with input and message list
4. Send a message — streaming response appears (requires server running with API key)
5. Mode toggle switches between auto/coaching/task
6. Sidebar shows conversation list
7. Dashboard has links to chat, memory, documents
  </verify>
  <done>Chat interface renders streaming responses via useChat + DefaultChatTransport. Conversation sidebar shows all conversations. Mode toggle switches between auto/coaching/task. Chat input supports Enter to send and Shift+Enter for newline. Dashboard links to all sections.</done>
</task>

<task type="auto">
  <name>Task 2: Build memory facts page and documents management page</name>
  <files>
    apps/web/src/app/(app)/memory/page.tsx
    apps/web/src/app/(app)/documents/page.tsx
  </files>
  <action>
**1. Create `apps/web/src/app/(app)/memory/page.tsx`:**

A "use client" page for viewing and managing user facts (MEM-04):

- Header: "What I Know About You" with subtext explaining the system extracts facts from conversations
- Uses tRPC `userFact.list` to fetch all facts
- Groups facts by category (goal, preference, context, relationship, work, personal)
- Each category section has a heading with a count
- Each fact card shows:
  - The fact text
  - Category badge (color-coded)
  - Confidence percentage
  - Source (conversation/document/manual)
  - Edit button (pencil icon) — opens inline edit mode (textarea + save/cancel)
  - Delete button (trash icon) — with confirmation dialog (window.confirm)
- Edit mode: inline textarea that replaces the fact text, Save and Cancel buttons
  - Save calls tRPC `userFact.update` with the new text
  - On success, invalidate the query to refresh
- Delete calls tRPC `userFact.delete`
- Empty state: "No facts recorded yet. Start a coaching conversation and I'll learn about you."
- Styling: Clean card layout with Tailwind. Category colors:
  - goal: green, preference: blue, context: purple, relationship: orange, work: slate, personal: pink

**2. Create `apps/web/src/app/(app)/documents/page.tsx`:**

A "use client" page for uploading and managing documents (MEM-02):

- Header: "Documents" with subtext "Upload documents to inform your coaching sessions"
- Upload section at top:
  - Drag-and-drop zone (or click to select file)
  - Accept: .pdf, .docx, .txt
  - Max size: 10MB (show in UI)
  - On file select, POST to `/api/documents/upload` using FormData with credentials: "include"
  - Show upload progress (or at minimum a loading spinner during upload)
  - On success, invalidate the documents list query
  - On error, show error message
- Document list below:
  - Uses tRPC `document.list` to fetch documents
  - Each document row shows: filename, file type icon/badge, size (formatted), status badge, upload date
  - Status badges: processing (yellow), ready (green), error (red)
  - Delete button on each document (with confirmation)
  - Delete calls tRPC `document.delete`
- Empty state: "No documents uploaded yet. Upload PDFs, Word documents, or text files to give your coach more context."
- File size formatter: show KB or MB as appropriate

For the upload, since the endpoint is a Hono route (not tRPC), use fetch directly:

```typescript
const SERVER_URL = process.env.NEXT_PUBLIC_SERVER_URL || "http://localhost:3001";

async function uploadDocument(file: File) {
  const formData = new FormData();
  formData.append("file", file);
  const res = await fetch(`${SERVER_URL}/api/documents/upload`, {
    method: "POST",
    body: formData,
    credentials: "include",
  });
  if (!res.ok) {
    const err = await res.json();
    throw new Error(err.error || "Upload failed");
  }
  return res.json();
}
```
  </action>
  <verify>
1. `cd apps/web && npx tsc --noEmit` — no type errors
2. Navigate to /memory — shows user facts grouped by category
3. Edit a fact — inline edit mode works, save updates via tRPC
4. Delete a fact — confirmation, then removes from list
5. Navigate to /documents — shows upload zone and document list
6. Upload a file — calls /api/documents/upload, appears in list
7. Delete a document — confirmation, then removes from list
  </verify>
  <done>Memory page displays user facts grouped by category with inline edit and delete. Documents page provides file upload (drag-and-drop or click) with document list showing status, and delete functionality. Both pages use tRPC for data operations.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete coaching & memory experience</name>
  <files>n/a — human verification checkpoint</files>
  <action>
  Human verifies the complete Phase 2 coaching and memory experience.

  What was built: Complete Phase 2 — streaming chat with RAG context, mode switching, document upload, and memory management.

  Prerequisites: Both server and web dev servers running (`npm run dev` from root). Database pushed with pgvector enabled (`cd apps/server && npm run db:setup`). At least ANTHROPIC_API_KEY set in .env. OPENAI_API_KEY set for embeddings (optional but needed for RAG).

  Verification steps:

  1. **Chat (COACH-01):** Go to http://localhost:3000/chat — should create a new conversation and redirect. Type a message and send. Verify streaming response appears word-by-word.

  2. **Mode detection (COACH-04):** Send "What are the pros and cons of hiring a new team member?" — should produce structured output (task mode detected). Send "I've been feeling overwhelmed lately" — should produce reflective coaching response.

  3. **Mode toggle (COACH-05):** Click the mode toggle to switch to "Task" mode. Send any message — response should be structured. Switch to "Coaching" mode — response should be reflective.

  4. **Conversation persistence:** Refresh the page. Previous messages should still be visible.

  5. **Conversation sidebar:** Create 2-3 conversations. Sidebar should list them all. Click between them. Delete one.

  6. **Documents (MEM-02):** Go to /documents. Upload a PDF or TXT file. Verify it appears in the list with "ready" status.

  7. **RAG context (COACH-02):** After uploading a document, go back to chat. Ask a question related to the document content. Verify the coach references the document content in its response (requires OPENAI_API_KEY for embeddings).

  8. **Memory/Facts (MEM-01, MEM-04):** After a few conversations, go to /memory. Verify facts have been extracted (requires ANTHROPIC_API_KEY). Edit a fact — verify it saves. Delete a fact — verify it disappears.

  9. **Dashboard navigation:** Go to /dashboard. Verify links to chat, memory, documents, and settings all work.
  </action>
  <verify>Human confirms all 9 verification steps pass. Type "approved" or describe issues.</verify>
  <done>All Phase 2 success criteria verified by human: streaming chat, mode detection/toggle, conversation persistence, document upload, RAG context, fact extraction, and full navigation.</done>
</task>

</tasks>

<verification>
1. Full chat flow works: create conversation, send messages, receive streaming responses
2. Mode auto-detection produces different response styles
3. Manual mode toggle overrides auto-detection
4. Conversations persist across page refreshes
5. Document upload processes and appears in list
6. RAG retrieval injects document/conversation context into responses
7. Fact extraction populates the memory page
8. Facts can be edited and deleted
9. All pages accessible from dashboard
</verification>

<success_criteria>
- User can have streaming chat conversations with the coach
- Coach references prior context (conversations + documents) in responses
- Mode auto-detection and manual toggle work correctly
- Documents can be uploaded, parsed, and their content used in coaching
- User facts are extracted from conversations and manageable
- All UI is functional and navigable
</success_criteria>

<output>
After completion, create `.planning/phases/02-coaching-memory/02-04-SUMMARY.md`
</output>
