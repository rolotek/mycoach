---
phase: 06-api-key-management
plan: 05
type: execute
wave: 4
depends_on: ["06-04"]
files_modified:
  - apps/web/src/app/(app)/agents/[id]/page.tsx
autonomous: false

must_haves:
  truths:
    - "User can set a preferred model per agent in the agent detail page"
    - "Agent model selection shows available models based on user's configured providers"
    - "Full flow verified: save key -> select model -> chat -> usage tracked"
  artifacts:
    - path: "apps/web/src/app/(app)/agents/[id]/page.tsx"
      provides: "Agent model selection dropdown"
      contains: "preferredModel"
  key_links:
    - from: "apps/web/src/app/(app)/agents/[id]/page.tsx"
      to: "trpc.agent.update"
      via: "mutation with preferredModel"
      pattern: "preferredModel"
---

<objective>
Add per-agent model selection to the agent detail page and perform end-to-end verification of the complete Phase 6 feature set.

Purpose: Agent-level model selection lets users optimize cost vs. performance per agent type. The verification checkpoint confirms the entire flow works end-to-end.
Output: Agent model selection UI. Human-verified complete flow.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-api-key-management-usage-tracking-users-can-set-individual-api-keys-for-anthropic-openai-select-models-track-token-usage-and-monitor-spending-against-budgets-using-provider-billing-apis/06-04-SUMMARY.md
@apps/web/src/app/(app)/agents/[id]/page.tsx
@apps/server/src/trpc/router.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add model selection dropdown to agent detail page</name>
  <files>apps/web/src/app/(app)/agents/[id]/page.tsx</files>
  <action>
Modify the agent detail/edit page to include a model selection dropdown:

1. Read the current agent detail page to understand its structure (it likely has name, description, systemPrompt fields with an update form).

2. Add a "Model" section to the agent edit form:
   - Label: "Preferred Model"
   - Helper text: "Override the default model for this agent. Leave as 'Use Default' to use your global setting."
   - Use a Select component from shadcn/ui
   - Options:
     - First option: "Use Default" with value "" (empty string = null = use user's default)
     - Then list available models from `trpc.llm.listProviders.useQuery()`:
       - For each provider, for each model, show: `${provider.name} - ${model.name}` with value `${model.id}` (the prefixed format like "anthropic:claude-sonnet-4-20250514")
   - Initialize the select value from the agent's current `preferredModel` (or "" if null)

3. When saving the agent, include `preferredModel` in the update mutation:
   - If value is "", pass `preferredModel: null`
   - If value is a model id, pass `preferredModel: value`

4. Follow existing page patterns for state management and mutation handling.
  </action>
  <verify>
Run `cd /Users/allenwong/Workspace/mycoach && npm run build` -- should pass.
Navigate to an agent detail page and confirm the model dropdown appears with "Use Default" and provider model options.
  </verify>
  <done>Agent detail page has a model selection dropdown that allows per-agent model override. Saving persists the selection. "Use Default" clears the override.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: End-to-end verification of Phase 6</name>
  <what-built>Complete API key management, model selection, token usage tracking, and budget enforcement system. Includes:
  - Encrypted API key storage (AES-256-GCM)
  - API key management UI (save with validation, masked display, delete)
  - Per-user model selection with fallback to env var
  - Per-agent model selection override
  - Token usage tracking in database
  - Usage dashboard with per-model breakdown
  - Monthly budget setting and enforcement
  </what-built>
  <how-to-verify>
1. Start the dev servers: `cd /Users/allenwong/Workspace/mycoach && npm run dev`
2. Log in and navigate to Settings (http://localhost:3000/settings)

**API Keys:**
3. In the API Keys section, enter a valid Anthropic API key and click "Save & Verify"
4. Confirm: key validates successfully, shows masked key (first 7 + last 4 chars), green indicator
5. (Optional) Enter a valid OpenAI key and verify same behavior
6. Delete one key and confirm it's removed

**Model Selection:**
7. In LLM Configuration, select your preferred provider and model
8. Set a monthly budget (e.g., $10)
9. Click Save

**Chat with User Key:**
10. Navigate to Chat and send a message
11. Confirm: response comes back (using your API key)
12. Go back to Settings and check the Usage Dashboard
13. Confirm: usage shows the request with token counts and estimated cost

**Agent Model Selection:**
14. Navigate to an agent's detail page
15. Set a preferred model different from your default
16. Save the agent
17. In Chat, trigger that agent (ask for something that dispatches to it)
18. Confirm: the agent executes (results appear)

**Budget Enforcement:**
19. Set the monthly budget to $0.01 in Settings
20. Send another chat message
21. Confirm: you get a budget exceeded error message

**Verify no regressions:**
22. Confirm: existing chat without custom keys still works (env var fallback)
23. Confirm: agent approval flow still works
24. Confirm: fact extraction still runs in background
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues found</resume-signal>
</task>

</tasks>

<verification>
- Agent detail page has model selection dropdown
- Full end-to-end flow works: keys -> model selection -> chat -> tracking -> budget
- No regressions in existing features
</verification>

<success_criteria>
Users can save API keys, select models (globally and per-agent), chat uses their keys and models, token usage is tracked and displayed, and budget enforcement works. Human verification confirms the complete flow.
</success_criteria>

<output>
After completion, create `.planning/phases/06-api-key-management-usage-tracking-users-can-set-individual-api-keys-for-anthropic-openai-select-models-track-token-usage-and-monitor-spending-against-budgets-using-provider-billing-apis/06-05-SUMMARY.md`
</output>
