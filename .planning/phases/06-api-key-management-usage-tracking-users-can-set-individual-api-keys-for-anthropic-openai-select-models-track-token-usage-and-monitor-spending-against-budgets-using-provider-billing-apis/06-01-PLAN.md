---
phase: 06-api-key-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/server/src/db/schema.ts
  - apps/server/src/crypto/encryption.ts
  - apps/server/src/llm/pricing.ts
  - .env.example
  - packages/shared/src/schemas/settings.ts
autonomous: true

must_haves:
  truths:
    - "userApiKeys table exists with encrypted_key column and unique constraint on userId+provider"
    - "tokenUsage table exists with inputTokens, outputTokens, estimatedCostCents columns"
    - "userSettings has monthlyBudgetCents column"
    - "agents table has preferredModel column"
    - "Encryption module can encrypt and decrypt a string round-trip"
    - "Pricing module returns non-zero cost for known models"
  artifacts:
    - path: "apps/server/src/db/schema.ts"
      provides: "userApiKeys and tokenUsage tables, monthlyBudgetCents on userSettings, preferredModel on agents"
      contains: "userApiKeys"
    - path: "apps/server/src/crypto/encryption.ts"
      provides: "AES-256-GCM encrypt/decrypt functions"
      exports: ["encrypt", "decrypt"]
    - path: "apps/server/src/llm/pricing.ts"
      provides: "MODEL_PRICING lookup and calculateCostCents function"
      exports: ["MODEL_PRICING", "calculateCostCents"]
    - path: "packages/shared/src/schemas/settings.ts"
      provides: "Updated settings schema with monthlyBudgetCents"
      exports: ["updateSettingsSchema"]
  key_links:
    - from: "apps/server/src/crypto/encryption.ts"
      to: "process.env.API_KEY_ENCRYPTION_KEY"
      via: "Buffer.from env var"
      pattern: "API_KEY_ENCRYPTION_KEY"
    - from: "apps/server/src/llm/pricing.ts"
      to: "apps/server/src/db/schema.ts"
      via: "estimatedCostCents column type alignment"
      pattern: "calculateCostCents"
---

<objective>
Create the data foundation for API key management and usage tracking: database tables (userApiKeys, tokenUsage), encryption module for API keys at rest, pricing lookup for cost estimation, and agent-level model selection column.

Purpose: Everything in Phase 6 depends on these schemas and utilities. Without encrypted storage there are no keys to use; without tokenUsage there is nothing to track; without pricing there are no costs to estimate.
Output: New DB tables ready to push, encryption module, pricing module, updated shared schema.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/server/src/db/schema.ts
@apps/server/src/llm/providers.ts
@packages/shared/src/schemas/settings.ts
@.env.example
@.planning/phases/06-api-key-management-usage-tracking-users-can-set-individual-api-keys-for-anthropic-openai-select-models-track-token-usage-and-monitor-spending-against-budgets-using-provider-billing-apis/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add database tables and columns for API keys, token usage, budget, and agent model selection</name>
  <files>apps/server/src/db/schema.ts, packages/shared/src/schemas/settings.ts</files>
  <action>
In `apps/server/src/db/schema.ts`:

1. Add `userApiKeys` table:
   - `id`: uuid PK defaultRandom
   - `userId`: text FK to user.id onDelete cascade
   - `provider`: varchar(50) notNull -- "anthropic" | "openai"
   - `encryptedKey`: text notNull -- AES-256-GCM encrypted
   - `isValid`: boolean default true
   - `lastValidatedAt`: timestamp nullable
   - `createdAt`: timestamp defaultNow notNull
   - `updatedAt`: timestamp defaultNow notNull
   - Indexes: `user_api_keys_userId_idx` on userId
   - Unique constraint: `user_api_keys_userId_provider_idx` on (userId, provider)

2. Add `tokenUsage` table:
   - `id`: uuid PK defaultRandom
   - `userId`: text FK to user.id onDelete cascade
   - `conversationId`: uuid FK to conversations.id onDelete set null (nullable)
   - `provider`: varchar(50) notNull
   - `model`: varchar(100) notNull
   - `inputTokens`: integer notNull default 0
   - `outputTokens`: integer notNull default 0
   - `estimatedCostCents`: integer notNull default 0 -- hundredths of a cent for precision
   - `createdAt`: timestamp defaultNow notNull
   - Indexes: `token_usage_userId_idx` on userId, `token_usage_userId_createdAt_idx` on (userId, createdAt)

3. Add to `userSettings` table:
   - `monthlyBudgetCents`: integer nullable (null = no limit)

4. Add to `agents` table:
   - `preferredModel`: varchar(100) nullable (null = use user's default)

5. Add relations for userApiKeys and tokenUsage:
   - `userApiKeysRelations`: user one-to-many
   - `tokenUsageRelations`: user one-to-many, conversation one-to-many
   - Update `userRelations` to include `apiKeys: many(userApiKeys)` and `tokenUsage: many(tokenUsage)`

In `packages/shared/src/schemas/settings.ts`:
- Add `monthlyBudgetCents: z.number().int().min(0).nullable().optional()` to `updateSettingsSchema`

After schema changes, run `npx drizzle-kit push` from repo root to apply to local DB.
  </action>
  <verify>
Run `cd /Users/allenwong/Workspace/mycoach && npx drizzle-kit push` -- should succeed with new tables created.
Run `npx tsx -e "import { userApiKeys, tokenUsage } from './apps/server/src/db/schema'; console.log('Tables exist:', !!userApiKeys, !!tokenUsage)"` -- should print "Tables exist: true true".
  </verify>
  <done>userApiKeys and tokenUsage tables exist in schema.ts with correct columns, indexes, and FK constraints. userSettings has monthlyBudgetCents. agents has preferredModel. Shared settings schema updated. Database pushed successfully.</done>
</task>

<task type="auto">
  <name>Task 2: Create encryption module and pricing lookup</name>
  <files>apps/server/src/crypto/encryption.ts, apps/server/src/llm/pricing.ts, .env.example</files>
  <action>
Create `apps/server/src/crypto/encryption.ts`:
- Import `createCipheriv`, `createDecipheriv`, `randomBytes` from `node:crypto`
- Read `ENCRYPTION_KEY` from `process.env.API_KEY_ENCRYPTION_KEY` (32-byte hex string). If env var is missing, log a warning but do not crash (allows app to start without it; encrypt/decrypt will throw if called).
- Export `encrypt(plaintext: string): string` -- generates random 12-byte IV, encrypts with AES-256-GCM, returns `iv:authTag:ciphertext` all hex-encoded
- Export `decrypt(encoded: string): string` -- splits on `:`, recreates decipher, returns plaintext
- Each call MUST generate a new random IV (never reuse)

Create `apps/server/src/llm/pricing.ts`:
- Export `MODEL_PRICING: Record<string, { inputPerMTok: number; outputPerMTok: number }>` with entries for:
  - `claude-sonnet-4-20250514`: 300 / 1500
  - `claude-haiku-3-20250414`: 25 / 125
  - `claude-sonnet-4`: 300 / 1500
  - `claude-haiku-4.5`: 100 / 500
  - `claude-opus-4.6`: 500 / 2500
  - `gpt-4o`: 250 / 1000
  - `gpt-4o-mini`: 15 / 60
- Export `calculateCostCents(model: string, inputTokens: number, outputTokens: number): number`
  - Look up model in pricing table
  - If unknown model, return 0
  - Calculate: `(inputTokens / 1_000_000) * inputPerMTok + (outputTokens / 1_000_000) * outputPerMTok`
  - Return `Math.round(result * 100)` (hundredths of a cent)

Update `.env.example`:
- Add `API_KEY_ENCRYPTION_KEY=` with comment: `# 32-byte hex key for encrypting user API keys. Generate with: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"`

Also generate a real key for local dev and add to `.env` if it does not already have one (use `node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"` and append to `.env`).
  </action>
  <verify>
Run: `cd /Users/allenwong/Workspace/mycoach && npx tsx -e "
import { encrypt, decrypt } from './apps/server/src/crypto/encryption';
const original = 'sk-ant-test-key-12345';
const encrypted = encrypt(original);
const decrypted = decrypt(encrypted);
console.log('Round-trip:', original === decrypted);
console.log('Encrypted format:', encrypted.split(':').length === 3);
"` -- should print "Round-trip: true" and "Encrypted format: true".

Run: `npx tsx -e "
import { calculateCostCents } from './apps/server/src/llm/pricing';
const cost = calculateCostCents('claude-sonnet-4-20250514', 1000, 500);
console.log('Cost > 0:', cost > 0);
const unknown = calculateCostCents('unknown-model', 1000, 500);
console.log('Unknown = 0:', unknown === 0);
"` -- should print "Cost > 0: true" and "Unknown = 0: true".
  </verify>
  <done>Encryption module encrypts/decrypts API keys with AES-256-GCM. Pricing module estimates costs for known models. .env.example documents the new API_KEY_ENCRYPTION_KEY variable. Local .env has a generated key.</done>
</task>

</tasks>

<verification>
- `npx drizzle-kit push` succeeds
- encrypt/decrypt round-trip works
- calculateCostCents returns correct values
- `npm run type-check` passes from repo root
</verification>

<success_criteria>
Database schema includes userApiKeys, tokenUsage tables and new columns on userSettings and agents. Encryption and pricing modules exist and function correctly. Schema is pushed to local database.
</success_criteria>

<output>
After completion, create `.planning/phases/06-api-key-management-usage-tracking-users-can-set-individual-api-keys-for-anthropic-openai-select-models-track-token-usage-and-monitor-spending-against-budgets-using-provider-billing-apis/06-01-SUMMARY.md`
</output>
