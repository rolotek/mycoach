---
phase: 06-api-key-management
plan: 04
type: execute
wave: 3
depends_on: ["06-02", "06-03"]
files_modified:
  - apps/web/src/app/(app)/settings/page.tsx
  - apps/server/src/trpc/router.ts
autonomous: true

must_haves:
  truths:
    - "User can enter, save, and delete API keys for Anthropic and OpenAI"
    - "Saved API keys display as masked (first 7 + last 4 chars)"
    - "User sees a green checkmark or error after saving a key (validation feedback)"
    - "User can select a default model from a dropdown"
    - "User can set a monthly budget in dollars"
    - "User can see current month usage (total spend, cost by provider, breakdown by model)"
    - "User can set a preferred model per agent on the agent settings"
  artifacts:
    - path: "apps/web/src/app/(app)/settings/page.tsx"
      provides: "API key management UI, model selection, budget input, usage dashboard"
      min_lines: 100
    - path: "apps/server/src/trpc/router.ts"
      provides: "usage.summary tRPC procedure for usage data"
      contains: "usageRouter"
  key_links:
    - from: "apps/web/src/app/(app)/settings/page.tsx"
      to: "trpc.apiKey.save"
      via: "mutation on form submit"
      pattern: "apiKey\\.save"
    - from: "apps/web/src/app/(app)/settings/page.tsx"
      to: "trpc.apiKey.list"
      via: "query for saved keys"
      pattern: "apiKey\\.list"
    - from: "apps/web/src/app/(app)/settings/page.tsx"
      to: "trpc.usage.summary"
      via: "query for usage data"
      pattern: "usage\\.summary"
---

<objective>
Build the Settings UI with API key management, model selection, budget configuration, and a usage dashboard showing current month spending. Also add agent-level model selection to the agent detail/edit page and a usage summary tRPC route.

Purpose: This is the user-facing layer that makes the entire Phase 6 backend accessible. Users need to be able to enter keys, pick models, set budgets, and see their usage.
Output: Expanded settings page with API keys, usage, and budget sections. Usage summary API endpoint.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-api-key-management-usage-tracking-users-can-set-individual-api-keys-for-anthropic-openai-select-models-track-token-usage-and-monitor-spending-against-budgets-using-provider-billing-apis/06-02-SUMMARY.md
@.planning/phases/06-api-key-management-usage-tracking-users-can-set-individual-api-keys-for-anthropic-openai-select-models-track-token-usage-and-monitor-spending-against-budgets-using-provider-billing-apis/06-03-SUMMARY.md
@apps/web/src/app/(app)/settings/page.tsx
@apps/server/src/trpc/router.ts
@apps/server/src/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add usage summary tRPC route</name>
  <files>apps/server/src/trpc/router.ts</files>
  <action>
Add a `usageRouter` to `apps/server/src/trpc/router.ts`:

1. Create `usageRouter = t.router({ ... })`:
   - `summary`: protectedProcedure, no input
     - Calculate start of current month: `new Date(now.getFullYear(), now.getMonth(), 1)`
     - Query tokenUsage for current month:
       ```
       const monthlyRows = await ctx.db
         .select({
           provider: tokenUsage.provider,
           model: tokenUsage.model,
           totalInput: sql<number>`COALESCE(SUM(${tokenUsage.inputTokens}), 0)`,
           totalOutput: sql<number>`COALESCE(SUM(${tokenUsage.outputTokens}), 0)`,
           totalCost: sql<number>`COALESCE(SUM(${tokenUsage.estimatedCostCents}), 0)`,
           requestCount: sql<number>`COUNT(*)`,
         })
         .from(tokenUsage)
         .where(and(eq(tokenUsage.userId, ctx.user.id), gte(tokenUsage.createdAt, startOfMonth)))
         .groupBy(tokenUsage.provider, tokenUsage.model);
       ```
     - Query userSettings for budget:
       ```
       const [settings] = await ctx.db.select().from(userSettings).where(eq(userSettings.userId, ctx.user.id));
       ```
     - Also compute byProvider: aggregate totalCost by provider (for UI to show cost per provider).
     - Return:
       ```
       {
         breakdown: monthlyRows,
         byProvider: [ { provider, totalCostCents }, ... ],
         totalCostCents: ...,
         monthlyBudgetCents: settings?.monthlyBudgetCents ?? null,
         periodStart: startOfMonth.toISOString(),
       }
       ```

2. Register in appRouter: `usage: usageRouter`
  </action>
  <verify>
Run `cd /Users/allenwong/Workspace/mycoach && npm run type-check` -- should pass.
  </verify>
  <done>usage.summary returns current month's token usage broken down by provider/model, total cost, and budget info.</done>
</task>

<task type="auto">
  <name>Task 2: Expand settings page with API key management, budget, and usage dashboard</name>
  <files>apps/web/src/app/(app)/settings/page.tsx</files>
  <action>
Rewrite `apps/web/src/app/(app)/settings/page.tsx` to have multiple sections. Keep the existing LLM Configuration card but add three new cards. Use existing shadcn/ui components (Card, Button, Label, Select, Input, Skeleton from `@/components/ui/`).

**Section structure (top to bottom):**

1. **API Keys Card** (new):
   - Title: "API Keys"
   - Description: "Add your own API keys to use your accounts with Anthropic and OpenAI."
   - For each provider ("anthropic", "openai"):
     - Row with provider name (Anthropic/OpenAI), masked key display (from apiKey.list), and action buttons
     - If key exists: show masked key text, a "Delete" button (calls apiKey.delete, with confirmation)
     - If no key: show an Input field (type="password", placeholder "sk-ant-..." or "sk-...") with a "Save & Verify" button
     - On save: call `apiKey.save` mutation. Show loading spinner while saving. On success: show green checkmark icon and invalidate apiKey.list query. On error: show error message.
   - Use `trpc.apiKey.list.useQuery()` for current keys
   - Use `trpc.apiKey.save.useMutation()` and `trpc.apiKey.delete.useMutation()` for mutations
   - After successful save or delete, invalidate the apiKey.list query with `utils.apiKey.list.invalidate()`

2. **LLM Configuration Card** (existing, enhanced):
   - Keep provider/model selects as-is
   - Add monthly budget input below the model select:
     - Label: "Monthly Budget"
     - Input type="number" step="1" min="0" placeholder="No limit"
     - Helper text: "Set a monthly spending limit in dollars. Leave empty for no limit."
     - Value: convert `settings.monthlyBudgetCents` from cents to dollars for display (divide by 100), convert back on save (multiply by 100)
   - Update the save handler to include `monthlyBudgetCents` in the mutation

3. **Usage Dashboard Card** (new):
   - Title: "Usage This Month"
   - Use `trpc.usage.summary.useQuery()`
   - If no data / loading: show Skeleton
   - Display:
     - Total spend: format as dollars (totalCostCents / 10000 since it's hundredths of a cent, display as "$X.XX")
     - Cost by provider: show each provider's estimated cost (e.g. "Anthropic: $X.XX Â· OpenAI: $X.XX") when byProvider is present
     - Budget bar (if budget set): visual progress bar showing spend/budget ratio. Green if under 75%, yellow if 75-90%, red if >90%
     - Breakdown table: columns for Model, Requests, Input Tokens, Output Tokens, Est. Cost
     - Each row from `breakdown` array
   - Use a simple HTML table styled with Tailwind, or a div-based grid

4. **Agent Model Selection** (handled separately -- on the agents detail page, not settings):
   - This will be addressed by adding a model select dropdown to the agent edit form on the `/agents/[id]` page. BUT to keep file ownership clean, this task only handles the settings page.
   - Instead, add a note in the LLM Configuration card: "You can also set per-agent models in the Agents page to optimize cost vs. performance."

**State management:**
- Use separate state for API key inputs (one per provider)
- Budget input state syncs from settings query
- All mutations invalidate their respective queries on success

**Styling:**
- Follow existing design system: shadcn/ui components, space-y-6 between cards, max-w-2xl container
- Use `text-muted-foreground` for helper text
- Use `text-destructive` for errors
- Use green color class for success indicators

**Important:** Use the `trpc` import from `@/lib/trpc` (existing pattern). Use `const utils = trpc.useUtils()` for query invalidation.
  </action>
  <verify>
Run `cd /Users/allenwong/Workspace/mycoach && npm run build` -- should pass (includes type-check + Next.js build).
  </verify>
  <done>Settings page has API key management (save/delete/masked display), model selection with budget input, and usage dashboard showing monthly spend breakdown. All sections use existing shadcn/ui components and follow the design system.</done>
</task>

</tasks>

<verification>
- `npm run build` passes
- Settings page renders API keys section, LLM config with budget, and usage dashboard
- API key save validates and shows feedback
- Budget displays in dollars, stores in cents
- Usage breakdown shows model-level detail
</verification>

<success_criteria>
Users can manage API keys (save with validation, view masked, delete), set a monthly budget, select default model, and view their usage dashboard with per-model breakdown -- all from the settings page.
</success_criteria>

<output>
After completion, create `.planning/phases/06-api-key-management-usage-tracking-users-can-set-individual-api-keys-for-anthropic-openai-select-models-track-token-usage-and-monitor-spending-against-budgets-using-provider-billing-apis/06-04-SUMMARY.md`
</output>
