---
phase: 05-ui-polish-styling
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - apps/web/src/app/(app)/chat/[id]/page.tsx
  - apps/web/src/app/(app)/chat/components/message-list.tsx
  - apps/web/src/app/(app)/chat/components/chat-input.tsx
  - apps/web/src/app/(app)/chat/components/mode-toggle.tsx
  - apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx
  - apps/web/src/app/(app)/chat/components/agent-approval.tsx
  - apps/web/src/app/(app)/chat/components/agent-result.tsx
autonomous: true
must_haves:
  truths:
    - "Conversation sidebar is a collapsible panel inside the main content area (not a second app-level sidebar)"
    - "Chat messages render markdown correctly using react-markdown (headers, code blocks, lists, tables, links)"
    - "User messages and coach messages are visually distinct with design token colors"
    - "Agent approval cards and result cards use semantic color tokens"
    - "Chat input uses shadcn/ui Textarea with auto-resize behavior"
    - "Streaming indicator uses a Skeleton or animated dots instead of plain '...'"
    - "The message list auto-scrolls to bottom and does not break when restyled"
    - "Feedback buttons use lucide-react ThumbsUp/ThumbsDown icons instead of +1/-1 text"
    - "Mode toggle uses semantic token colors instead of bg-blue-600"
  artifacts:
    - path: "apps/web/src/app/(app)/chat/[id]/page.tsx"
      provides: "Restyled chat page with sidebar + messages + input layout"
    - path: "apps/web/src/app/(app)/chat/components/message-list.tsx"
      provides: "Message list using ChatMarkdown instead of hand-rolled renderMarkdown"
    - path: "apps/web/src/app/(app)/chat/components/chat-input.tsx"
      provides: "Chat input with shadcn/ui styling"
    - path: "apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx"
      provides: "Conversation list sidebar with design tokens"
    - path: "apps/web/src/app/(app)/chat/components/agent-result.tsx"
      provides: "Agent result card with ChatMarkdown + feedback with icon buttons"
    - path: "apps/web/src/app/(app)/chat/components/agent-approval.tsx"
      provides: "Agent approval card with shadcn/ui Button"
  key_links:
    - from: "apps/web/src/app/(app)/chat/components/message-list.tsx"
      to: "@/components/chat-markdown"
      via: "import ChatMarkdown"
      pattern: "import.*ChatMarkdown.*from.*@/components/chat-markdown"
    - from: "apps/web/src/app/(app)/chat/components/agent-result.tsx"
      to: "@/components/chat-markdown"
      via: "import ChatMarkdown"
      pattern: "import.*ChatMarkdown.*from.*@/components/chat-markdown"
    - from: "apps/web/src/app/(app)/chat/[id]/page.tsx"
      to: "conversation-sidebar"
      via: "Sheet or collapsible panel"
      pattern: "ConversationSidebar"
---

<objective>
Restyle the entire chat interface: conversation sidebar, message list with proper markdown rendering, chat input, mode toggle, agent approval/result cards, and feedback buttons.

Purpose: The chat page is the core UX of the app -- where users spend most of their time. It has the most components (7 files) and the most complex layout (sidebar + scrollable messages + pinned input). Proper markdown rendering replaces two fragile hand-rolled regex parsers.

Output: A polished chat experience with react-markdown rendering, design-token-styled messages, icon-based feedback, and responsive conversation sidebar.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-ui-polish-styling/05-RESEARCH.md
@.planning/phases/05-ui-polish-styling/05-01-SUMMARY.md
@apps/web/src/app/(app)/chat/[id]/page.tsx
@apps/web/src/app/(app)/chat/components/message-list.tsx
@apps/web/src/app/(app)/chat/components/chat-input.tsx
@apps/web/src/app/(app)/chat/components/mode-toggle.tsx
@apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx
@apps/web/src/app/(app)/chat/components/agent-approval.tsx
@apps/web/src/app/(app)/chat/components/agent-result.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Restyle conversation sidebar, chat page layout, mode toggle, and chat input</name>
  <files>
    apps/web/src/app/(app)/chat/[id]/page.tsx
    apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx
    apps/web/src/app/(app)/chat/components/mode-toggle.tsx
    apps/web/src/app/(app)/chat/components/chat-input.tsx
  </files>
  <action>
    **Conversation Sidebar (`conversation-sidebar.tsx`):**
    - Replace the `<aside className="flex w-64 ...">` with a responsive design:
      - On desktop (md+): render as a collapsible side panel within the chat content area using a `<div>` with `w-64 shrink-0 border-r border-border bg-card` and a toggle button to show/hide
      - On mobile: use shadcn/ui Sheet component (slide-in from left) triggered by a button in the chat header
    - Accept a new prop `open` and `onOpenChange` for mobile Sheet control, and `collapsed`/`onCollapsedChange` for desktop toggle
    - Replace "New Chat" link: use `<Button className="w-full" size="sm">` with Plus icon from lucide-react
    - Conversation list items: use `bg-accent` for active state instead of `bg-blue-50`. Text uses `text-foreground` and `text-muted-foreground` for date.
    - Delete button: use `text-muted-foreground hover:text-destructive` instead of raw neutral classes
    - Loading state: 3 `<Skeleton>` items instead of "Loading..." text
    - Replace all raw color classes with semantic tokens

    **Chat page layout (`chat/[id]/page.tsx`):**
    - Remove the `min-h-screen` wrapper -- the app shell handles this now
    - Structure the page as a full-height flex container that fills the SidebarInset content area:
      ```
      <div className="flex h-[calc(100vh-3.5rem)] overflow-hidden">
        <ConversationSidebar ... />
        <div className="flex flex-1 flex-col min-w-0">
          <header>...</header>
          <MessageList ... />
          <ChatInput ... />
        </div>
      </div>
      ```
      The `h-[calc(100vh-3.5rem)]` accounts for the app shell header (h-14 = 3.5rem).
    - Chat header bar: use `border-b border-border bg-card` instead of raw neutral classes. Include a mobile sidebar toggle button (Sheet trigger), the page title "Coach", and the ModeToggle.
    - Loading state: use Skeleton components (a sidebar skeleton + centered skeleton block) instead of plain "Loading..."
    - Keep all existing logic (useParams, trpc query, useCoachingChat, useEffect for message hydration, handleSubmit) unchanged

    **Mode toggle (`mode-toggle.tsx`):**
    - Replace the outer div border with `rounded-lg border border-border p-1`
    - Active button: `bg-primary text-primary-foreground` instead of `bg-blue-600 text-white`
    - Inactive button: `text-muted-foreground hover:bg-accent hover:text-accent-foreground`
    - No other logic changes needed

    **Chat input (`chat-input.tsx`):**
    - Replace the `<textarea>` with shadcn/ui `<Textarea>` component (import from @/components/ui/textarea)
    - Style: `flex-1 resize-none border-input bg-background focus-visible:ring-1 focus-visible:ring-ring` (the Textarea component provides base styles; override min-height and max-height)
    - Keep the auto-resize useEffect logic exactly as-is
    - Replace submit `<button>` with `<Button size="icon">` with Send icon from lucide-react (or keep text "Send" with `<Button>`)
    - Outer form: `border-t border-border p-4 bg-card`
    - Replace all raw color classes with semantic tokens
  </action>
  <verify>
    - `cd apps/web && npx tsc --noEmit` passes
    - `grep "bg-blue-600\|bg-neutral-\|border-neutral-\|text-neutral-" apps/web/src/app/\\(app\\)/chat/\\[id\\]/page.tsx` returns NO matches
    - `grep "bg-blue-600\|bg-neutral-\|border-neutral-\|text-neutral-" apps/web/src/app/\\(app\\)/chat/components/conversation-sidebar.tsx` returns NO matches
    - `grep "bg-blue-600" apps/web/src/app/\\(app\\)/chat/components/mode-toggle.tsx` returns NO matches
    - `grep "bg-blue-600\|border-neutral-" apps/web/src/app/\\(app\\)/chat/components/chat-input.tsx` returns NO matches
  </verify>
  <done>
    Chat page layout uses a full-height flex container within the app shell. Conversation sidebar is responsive (collapsible panel on desktop, Sheet on mobile). Mode toggle and chat input use design tokens. No raw color classes remain in any of these four files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Restyle message list with ChatMarkdown, agent cards, and feedback buttons</name>
  <files>
    apps/web/src/app/(app)/chat/components/message-list.tsx
    apps/web/src/app/(app)/chat/components/agent-approval.tsx
    apps/web/src/app/(app)/chat/components/agent-result.tsx
  </files>
  <action>
    **Message list (`message-list.tsx`):**
    - DELETE the entire `renderMarkdown()` function (lines ~36-72). Replace all usages with the shared `ChatMarkdown` component from `@/components/chat-markdown`.
    - Import ChatMarkdown: `import { ChatMarkdown } from "@/components/chat-markdown"`
    - User message bubble: `bg-primary text-primary-foreground` instead of `bg-blue-600 text-white`
    - Coach message bubble: `bg-muted text-foreground` instead of `bg-neutral-100 text-neutral-900`
    - Replace `{renderMarkdown(text)}` with `<ChatMarkdown content={text} />` in the message rendering
    - Empty state: use `text-muted-foreground` instead of `text-neutral-500`
    - Streaming indicator: replace the plain "..." with a more polished indicator -- use three animated dots with `<span className="flex gap-1"><span className="h-2 w-2 animate-bounce rounded-full bg-muted-foreground/40" style={{ animationDelay: "0ms" }} /><span className="h-2 w-2 animate-bounce rounded-full bg-muted-foreground/40" style={{ animationDelay: "150ms" }} /><span className="h-2 w-2 animate-bounce rounded-full bg-muted-foreground/40" style={{ animationDelay: "300ms" }} /></span>` inside the existing bubble wrapper
    - "Routing to {agentName}..." status: use `bg-muted text-muted-foreground` instead of `bg-neutral-100 text-neutral-500`
    - Message role label ("You" / "Coach"): use `opacity-70` or `text-xs font-medium` -- keep the existing pattern but replace raw colors
    - Scroll area: keep the `overflow-y-auto` and `flex-1` pattern. Use `ScrollArea` from shadcn/ui if it provides better scroll behavior, otherwise keep the current div-based scroll (the existing scrollIntoView pattern works well).
    - Keep ALL existing logic: parts filtering, dispatch parts handling, tool approval routing, etc. Only change styling and markdown rendering.

    **Agent approval card (`agent-approval.tsx`):**
    - Import Button from @/components/ui/button
    - Replace card wrapper: use `rounded-lg border-2 border-primary/20 bg-primary/5 px-4 py-3` (or use a Card with custom border color) instead of `border-indigo-200 bg-indigo-50/50`
    - Title "Chief of Staff suggests: Delegate to {agentName}": use `text-sm font-medium text-foreground` instead of `text-indigo-900`
    - Task description: `text-muted-foreground` instead of `text-neutral-700`
    - Approve button: `<Button size="sm" variant="default">Approve</Button>` (uses primary color)
    - Deny button: `<Button size="sm" variant="outline">Deny</Button>`
    - Remove all raw color classes (bg-green-600, border-indigo-200, etc.)

    **Agent result card + feedback buttons (`agent-result.tsx`):**
    - DELETE the `renderMarkdown()` function from this file (duplicate of the one in message-list.tsx). Import ChatMarkdown from `@/components/chat-markdown`.
    - Result card: replace `border-green-200 bg-green-50/50` with a design-token approach. Use a subtle success-like styling: `rounded-lg border bg-card px-4 py-3 shadow-sm` with a small colored accent (e.g., a left border `border-l-4 border-green-500` or a Badge showing the agent name)
    - Title: `text-sm font-medium text-foreground` with a Badge for the agent name
    - Result content: `<ChatMarkdown content={result} />` instead of `{renderMarkdown(result)}`
    - "Agent dispatch was declined" (AgentDeniedCard): `bg-muted text-muted-foreground` instead of `bg-neutral-100 text-neutral-500`
    - Feedback buttons: Replace "+1"/"-1" text with lucide-react icons: `<ThumbsUp className="h-4 w-4" />` and `<ThumbsDown className="h-4 w-4" />`. Use `<Button variant="ghost" size="icon" className="h-8 w-8">` for each.
    - Feedback border: `border-t border-border` instead of `border-green-200`
    - Correction textarea: use shadcn/ui `<Textarea>` component
    - Submit correction button: `<Button size="sm" variant="secondary">Submit correction</Button>`
    - "Thanks for the feedback" / "Noted" text: `text-muted-foreground`
    - Remove ALL raw color classes
  </action>
  <verify>
    - `cd apps/web && npx tsc --noEmit` passes
    - `grep "renderMarkdown" apps/web/src/app/\\(app\\)/chat/components/message-list.tsx` returns NO matches (function removed)
    - `grep "renderMarkdown" apps/web/src/app/\\(app\\)/chat/components/agent-result.tsx` returns NO matches (function removed)
    - `grep "ChatMarkdown" apps/web/src/app/\\(app\\)/chat/components/message-list.tsx` returns matches
    - `grep "ChatMarkdown" apps/web/src/app/\\(app\\)/chat/components/agent-result.tsx` returns matches
    - `grep "bg-blue-600\|bg-neutral-\|border-neutral-\|text-neutral-\|bg-indigo-\|border-indigo-\|bg-green-100\|border-green-200" apps/web/src/app/\\(app\\)/chat/components/message-list.tsx` returns NO matches
    - `grep "bg-green-50\|border-green-200\|text-green-900\|bg-neutral-\|text-neutral-" apps/web/src/app/\\(app\\)/chat/components/agent-result.tsx` returns NO matches
  </verify>
  <done>
    Message list renders markdown via shared ChatMarkdown component (react-markdown + remark-gfm). Both duplicate renderMarkdown() functions are deleted. Agent approval and result cards use design tokens. Feedback buttons use ThumbsUp/ThumbsDown icons. All chat components use semantic color tokens with no raw Tailwind colors.
  </done>
</task>

</tasks>

<verification>
- `cd apps/web && npm run build` completes without errors
- ALL 7 chat component files use semantic design tokens (no raw bg-blue-*, bg-neutral-*, text-neutral-*, border-neutral-* classes)
- Both hand-rolled renderMarkdown() functions are deleted, replaced by shared ChatMarkdown component
- Chat message list auto-scrolls to bottom correctly
- Agent approval card has Approve/Deny buttons using shadcn/ui Button
- Agent result card renders markdown via ChatMarkdown
- Feedback uses ThumbsUp/ThumbsDown icons
- Streaming indicator uses animated dots instead of "..."
</verification>

<success_criteria>
- Chat page fills the app shell content area with proper flex layout (no extra min-h-screen)
- Conversation sidebar is responsive: panel on desktop, Sheet on mobile
- Message bubbles use bg-primary/text-primary-foreground for user, bg-muted/text-foreground for coach
- Full markdown rendering (headers, code blocks, lists, tables, links) works in chat messages and agent results
- Both renderMarkdown() duplicates are eliminated
- Feedback buttons show ThumbsUp/ThumbsDown icons
- Mode toggle uses primary color tokens
- All 7 files use semantic tokens exclusively
- `npm run build` passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-ui-polish-styling/05-03-SUMMARY.md`
</output>
