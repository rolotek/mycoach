---
phase: 05-ui-polish-styling
plan: 06
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/server/src/db/schema.ts
  - apps/server/src/trpc/router.ts
  - apps/server/src/agents/agent-executor.ts
  - apps/server/src/agents/resolve-approved-dispatch.ts
  - apps/server/src/coaching/chat-route.ts
autonomous: true

must_haves:
  truths:
    - "Conversations table has type column distinguishing coaching vs task threads"
    - "Conversations table has parentId column linking task threads to their coaching parent"
    - "getOrCreateCoaching returns the single coaching conversation for a user, creating one if none exists"
    - "reset mutation clears coaching conversation messages but leaves userFacts and memories intact"
    - "When an agent dispatch is approved and executed, a task thread conversation is created with the full result"
  artifacts:
    - path: "apps/server/src/db/schema.ts"
      provides: "conversations table with type and parentId columns"
      contains: "type.*coaching.*task"
    - path: "apps/server/src/trpc/router.ts"
      provides: "getOrCreateCoaching and reset mutations"
      contains: "getOrCreateCoaching"
    - path: "apps/server/src/agents/agent-executor.ts"
      provides: "task thread creation on agent execution"
      contains: "task.*thread"
  key_links:
    - from: "apps/server/src/trpc/router.ts"
      to: "apps/server/src/db/schema.ts"
      via: "getOrCreateCoaching queries conversations where type=coaching"
      pattern: "type.*coaching"
    - from: "apps/server/src/agents/agent-executor.ts"
      to: "apps/server/src/db/schema.ts"
      via: "creates task thread conversation with parentId"
      pattern: "parentId"
---

<objective>
Add conversation type/parentId columns to the database, create getOrCreateCoaching and reset tRPC mutations, and modify agent execution to create task thread conversations.

Purpose: This is the backend foundation for the hybrid coaching + task thread model. Without these schema changes and mutations, the frontend cannot distinguish coaching from task threads or implement the pinned coaching sidebar.

Output: Updated schema with migration, new tRPC procedures, agent executor creating task threads.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-ui-polish-styling/05-CONTEXT.md
@.planning/phases/05-ui-polish-styling/05-RESEARCH.md
@apps/server/src/db/schema.ts
@apps/server/src/trpc/router.ts
@apps/server/src/agents/agent-executor.ts
@apps/server/src/agents/resolve-approved-dispatch.ts
@apps/server/src/coaching/chat-route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add type and parentId columns to conversations table + DB migration</name>
  <files>apps/server/src/db/schema.ts</files>
  <action>
Add two new columns to the `conversations` table in schema.ts:

1. `type` — `text("type").default("coaching").notNull()` — Values: "coaching" or "task". Default "coaching" so existing conversations are treated as coaching threads.

2. `parentId` — `uuid("parent_id").references(() => conversations.id, { onDelete: "cascade" })` — Nullable. For task threads, this points to the parent coaching conversation. For coaching threads, this is null.

Add an index on parentId for efficient task thread lookups:
`index("conversations_parentId_idx").on(table.parentId)`

Update the `conversationRelations` to include a self-referencing relationship:
- `parent: one(conversations, { fields: [conversations.parentId], references: [conversations.id], relationName: "conversationParent" })`
- Also add to the conversations relation on the user side: `children: many(conversations, { relationName: "conversationParent" })`

After modifying schema.ts, run `npx drizzle-kit push` from the `apps/server` directory to push the schema changes to the database. The project uses Drizzle push (not migration files).

IMPORTANT: Do NOT change the default value of the existing `mode` column. The `type` column is separate from `mode` — `type` distinguishes coaching vs task threads, while `mode` distinguishes auto/coaching/task conversation modes within a thread.
  </action>
  <verify>
Run `cd apps/server && npx drizzle-kit push` — should succeed with schema changes applied.
Run `cd apps/server && npx tsc --noEmit` — no type errors.
  </verify>
  <done>
conversations table has `type` (text, default "coaching") and `parentId` (uuid, nullable, FK to conversations.id) columns. Schema compiles and DB is updated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add getOrCreateCoaching, reset, and listTaskThreads tRPC procedures + task thread creation in agent executor</name>
  <files>apps/server/src/trpc/router.ts, apps/server/src/agents/agent-executor.ts, apps/server/src/agents/resolve-approved-dispatch.ts, apps/server/src/coaching/chat-route.ts</files>
  <action>
**In apps/server/src/trpc/router.ts**, add these procedures to the `conversationRouter`:

1. `getOrCreateCoaching` — protectedProcedure mutation (no input needed):
   - Query: `SELECT * FROM conversations WHERE userId = ctx.user.id AND type = 'coaching' ORDER BY updatedAt DESC LIMIT 1`
   - If found, return it.
   - If not found, insert a new conversation with `{ userId: ctx.user.id, type: "coaching", mode: "auto" }` and return it.
   - This ensures there is always exactly one coaching thread per user.

2. `reset` — protectedProcedure mutation with input `{ id: z.string().uuid() }`:
   - Verify the conversation belongs to ctx.user.id and has type "coaching".
   - Set `messages` to `[]`, `title` to null, `updatedAt` to new Date().
   - Delete associated `memories` rows where `conversationId = input.id` (conversation-specific memories).
   - Do NOT delete userFacts — those persist across resets.
   - Return `{ success: true }`.

3. `listTaskThreads` — protectedProcedure query with input `{ parentId: z.string().uuid() }`:
   - Query task thread conversations where `userId = ctx.user.id AND parentId = input.parentId AND type = 'task'`.
   - Order by `createdAt DESC`.
   - Return `{ id, title, createdAt, updatedAt }` for each.

4. Update the existing `list` procedure to also return the `type` field in the select.

5. Update the existing `create` procedure to accept an optional `type` (default "coaching") and optional `parentId` in the input schema. Add these to the insert values.

**In apps/server/src/agents/agent-executor.ts**, modify `executeSpecialistAgent`:
   - After successfully generating the agent result (after the `generateText` call and DB update), create a task thread conversation:
     ```
     const [taskThread] = await db.insert(conversations).values({
       userId,
       type: "task",
       parentId: conversationId ?? null,
       title: `${agent.name}: ${task.slice(0, 80)}`,
       mode: "task",
       messages: [
         { id: crypto.randomUUID(), role: "user", parts: [{ type: "text", text: `Task: ${task}` }] },
         { id: crypto.randomUUID(), role: "assistant", parts: [{ type: "text", text: result.text }] },
       ],
     }).returning({ id: conversations.id });
     ```
   - Return the taskThread id in the result as `taskThreadId`.
   - Update the return type to include `taskThreadId: string`.

**In apps/server/src/agents/resolve-approved-dispatch.ts**, update `ExecutedDispatchResult` output type to include `taskThreadId: string`. Pass it through from the agent executor result.

**In apps/server/src/coaching/chat-route.ts**, the chat route's `onFinish` callback already saves messages. No changes needed here — the task thread conversation is created by the agent executor, and the inline summary card will be handled on the frontend in a later plan.

Run type-check after all changes to ensure consistency.
  </action>
  <verify>
Run `cd apps/server && npx tsc --noEmit` — no type errors.
Run `cd apps/web && npx tsc --noEmit` — no type errors (verify frontend types still compatible).
Start the dev server briefly: `cd apps/server && npx tsx src/index.ts` — should start without crashes (Ctrl+C after confirming).
  </verify>
  <done>
- `conversation.getOrCreateCoaching` returns existing or creates new coaching thread.
- `conversation.reset` clears coaching messages while preserving userFacts.
- `conversation.listTaskThreads` returns task threads for a parent conversation.
- `conversation.list` returns type field.
- `conversation.create` accepts optional type and parentId.
- Agent executor creates a task thread conversation with the full result and returns taskThreadId.
- All types compile cleanly on both server and web.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes in both apps/server and apps/web
- conversations table has type and parentId columns (verify via drizzle-kit push output)
- getOrCreateCoaching creates a coaching conversation on first call, returns same one on second call
- reset clears messages array to [] but does not touch userFacts table
- Agent executor creates a task thread conversation with parentId pointing to the source conversation
</verification>

<success_criteria>
Backend fully supports the hybrid coaching + task thread model: schema has type/parentId, tRPC has getOrCreateCoaching/reset/listTaskThreads, agent executor creates task threads on dispatch completion. All type checks pass.
</success_criteria>

<output>
After completion, create `.planning/phases/05-ui-polish-styling/05-06-SUMMARY.md`
</output>
