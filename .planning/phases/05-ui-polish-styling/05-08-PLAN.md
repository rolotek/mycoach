---
phase: 05-ui-polish-styling
plan: 08
type: execute
wave: 3
depends_on: ["05-07"]
files_modified:
  - e2e/05-conversation-model.spec.ts
autonomous: false

must_haves:
  truths:
    - "Build compiles with zero errors"
    - "Coaching thread is accessible and functional end-to-end"
    - "Task threads are created on agent dispatch and viewable"
    - "Reset clears coaching messages but memory persists"
    - "Sidebar layout matches locked decision exactly"
  artifacts:
    - path: "e2e/05-conversation-model.spec.ts"
      provides: "E2E smoke tests for conversation model"
      min_lines: 20
  key_links:
    - from: "apps/web/src/app/(app)/chat/page.tsx"
      to: "/api/trpc/conversation.getOrCreateCoaching"
      via: "tRPC query on page load"
      pattern: "getOrCreateCoaching"
---

<objective>
Build verification, E2E smoke tests, and human verification of the hybrid coaching + task thread UX.

Purpose: Confirm the entire conversation model works end-to-end and matches the locked decision layout before closing the phase.

Output: Passing build, E2E tests, and human-approved UX.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-ui-polish-styling/05-CONTEXT.md
@.planning/phases/05-ui-polish-styling/05-06-SUMMARY.md
@.planning/phases/05-ui-polish-styling/05-07-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build verification + E2E smoke tests for conversation model</name>
  <files>
    e2e/05-conversation-model.spec.ts
  </files>
  <action>
1. Run full build check:
   - `cd apps/server && npx tsc --noEmit` (server types)
   - `cd apps/web && npx tsc --noEmit` (client types)
   - `cd apps/web && npx next build` (full Next.js build -- catches runtime issues like missing imports)

2. Fix any build errors found. Common issues to watch for:
   - Missing imports for new tRPC procedures (getOrCreateCoaching, reset, listTaskThreads)
   - Type mismatches from updated agent-executor return type (taskThreadId)
   - Unused imports from removed components

3. Create E2E smoke test file `e2e/05-conversation-model.spec.ts` with Playwright tests:
   - Test: "/chat redirects to coaching thread" -- navigate to /chat, assert URL changes to /chat/[uuid]
   - Test: "Sidebar shows Coaching pinned item" -- on /chat/[id], assert sidebar contains "Coaching" text
   - Test: "Sidebar shows reset button" -- assert reset button is visible in sidebar
   - Test: "Sidebar shows Recent Tasks section" -- assert "Recent Tasks" label exists
   - Test: "Task thread page shows back to coaching link" -- if a task thread exists, navigate to it and verify back link

   Follow the existing pattern from `e2e/05-ui-polish.spec.ts` for auth setup and page navigation patterns.

4. Run the E2E tests: `npx playwright test e2e/05-conversation-model.spec.ts`
  </action>
  <verify>
    Build passes (tsc + next build). E2E tests pass.
  </verify>
  <done>
    - Server and client TypeScript compilation passes
    - Next.js build succeeds
    - E2E tests for conversation model pass
    - No runtime errors
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Human verification of coaching + task thread UX</name>
  <action>
    Human verifies the complete coaching + task thread conversation model:

    1. Navigate to http://localhost:3000/chat
       - Verify you land on the coaching thread (not a new conversation prompt)
       - Verify sidebar shows "Coaching" pinned at top with a reset icon button

    2. Send a message in the coaching chat
       - Verify the coach responds normally in the coaching thread
       - Verify the sidebar still shows "Coaching" as active

    3. If you have agents set up, trigger an agent dispatch:
       - Ask the coach to do something that triggers agent routing (e.g., "Review this contract...")
       - Approve the dispatch
       - Verify a compact summary card appears in the coaching chat (NOT the full result)
       - Verify the card shows agent name, task description, and "View result" link
       - Verify a new task thread appears in the sidebar under "Recent Tasks"

    4. Click "View result" on the summary card
       - Verify you navigate to the task thread page
       - Verify the full agent result is displayed with feedback buttons
       - Verify there is a "Back to Coaching" link
       - Click it and verify you return to the coaching thread

    5. Test the reset button:
       - Send a few messages in coaching chat
       - Click the reset button in the sidebar
       - Confirm the dialog
       - Verify messages are cleared
       - Send a new message -- verify the coach still knows facts about you (memory persisted)

    6. Check responsive layout:
       - Resize to mobile width
       - Verify sidebar is hidden and accessible via hamburger menu
       - Verify the coaching/task thread layout works on mobile
  </action>
  <verify>User confirms all 6 verification steps pass.</verify>
  <done>Human types "approved" or provides issues to fix.</done>
</task>

</tasks>

<verification>
1. Full build passes (server tsc, client tsc, next build)
2. E2E conversation model tests pass
3. Human verification confirms:
   - Coaching thread pinned with reset
   - Task threads listed by recency
   - Inline summary cards work
   - Reset preserves memory
   - Mobile responsive
</verification>

<success_criteria>
- Zero build errors
- E2E tests green
- Human approves the coaching + task thread UX
- Phase 5 conversation model complete
</success_criteria>

<output>
After completion, create `.planning/phases/05-ui-polish-styling/05-08-SUMMARY.md`
</output>
