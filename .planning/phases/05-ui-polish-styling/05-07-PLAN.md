---
phase: 05-ui-polish-styling
plan: 07
type: execute
wave: 2
depends_on: ["05-06"]
files_modified:
  - apps/web/src/app/(app)/chat/page.tsx
  - apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx
  - apps/web/src/app/(app)/chat/[id]/page.tsx
  - apps/web/src/components/app-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "Navigating to /chat opens the pinned coaching thread, not a new conversation every time"
    - "Sidebar shows pinned Coaching thread at top with a reset button"
    - "Sidebar shows task threads below the coaching thread, ordered by recency"
    - "Clicking reset clears coaching messages but user sees same coaching thread"
    - "Task threads are individually deletable from the sidebar"
  artifacts:
    - path: "apps/web/src/app/(app)/chat/page.tsx"
      provides: "getOrCreateCoaching redirect logic"
      contains: "getOrCreateCoaching"
    - path: "apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx"
      provides: "Pinned coaching thread + task thread list + reset button"
      contains: "reset"
    - path: "apps/web/src/app/(app)/chat/[id]/page.tsx"
      provides: "Chat detail page compatible with both coaching and task threads"
  key_links:
    - from: "apps/web/src/app/(app)/chat/page.tsx"
      to: "tRPC conversation.getOrCreateCoaching"
      via: "mutation call then router.replace"
      pattern: "getOrCreateCoaching"
    - from: "apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx"
      to: "tRPC conversation.reset"
      via: "reset button click handler"
      pattern: "conversation\\.reset"
    - from: "apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx"
      to: "tRPC conversation.listTaskThreads"
      via: "query for task threads"
      pattern: "listTaskThreads"
---

<objective>
Refactor the chat routing and conversation sidebar to implement the pinned coaching thread model with task threads listed below.

Purpose: Per user decision, the coaching thread is always pinned at top of sidebar. Users should land on their coaching thread when clicking "Chat" in navigation. Task threads (created by agent dispatches) appear below, organized by recency.

Output: /chat redirects to coaching thread, sidebar shows pinned coaching + task threads, reset button works.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-ui-polish-styling/05-CONTEXT.md
@.planning/phases/05-ui-polish-styling/05-06-SUMMARY.md
@apps/web/src/app/(app)/chat/page.tsx
@apps/web/src/app/(app)/chat/[id]/page.tsx
@apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx
@apps/web/src/components/app-sidebar.tsx
@apps/web/src/lib/trpc.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor /chat page to use getOrCreateCoaching</name>
  <files>apps/web/src/app/(app)/chat/page.tsx</files>
  <action>
Replace the current `/chat` page that creates a NEW conversation every time with one that calls `getOrCreateCoaching`:

```tsx
"use client";

import { useEffect } from "react";
import { useRouter } from "next/navigation";
import { trpc } from "@/lib/trpc";

export default function ChatPage() {
  const router = useRouter();
  const getOrCreate = trpc.conversation.getOrCreateCoaching.useMutation({
    onSuccess: (data) => {
      router.replace(`/chat/${data.id}`);
    },
  });

  useEffect(() => {
    getOrCreate.mutate();
  }, []);

  return (
    <div className="flex min-h-screen items-center justify-center bg-background">
      <p className="text-muted-foreground">
        {getOrCreate.isPending ? "Loading coaching session..." : "Redirecting..."}
      </p>
    </div>
  );
}
```

This ensures clicking "Chat" in the app sidebar always navigates to the single coaching thread, not a new conversation. The getOrCreateCoaching mutation (from Plan 05-06) returns the existing coaching thread or creates one.
  </action>
  <verify>
`cd apps/web && npx tsc --noEmit` passes.
Manual test: Navigate to /chat twice in a row — both times should land on the same conversation ID.
  </verify>
  <done>
/chat always redirects to the user's single coaching thread via getOrCreateCoaching, never creating duplicate conversations.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor conversation sidebar with pinned coaching + task threads + reset</name>
  <files>apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx, apps/web/src/app/(app)/chat/[id]/page.tsx, apps/web/src/components/app-sidebar.tsx</files>
  <action>
**Rewrite `conversation-sidebar.tsx`** to implement the locked decision sidebar layout:

```
Coaching (pinned)           [reset]
-------------------------------
Recent Tasks
  Contract Review            Feb 14
  Meeting Prep               Feb 13
```

The sidebar must have two sections:

**Section 1: Pinned Coaching Thread**
- Use `trpc.conversation.getOrCreateCoaching.useMutation` on mount to get the coaching thread ID.
- Display "Coaching" as a pinned link that navigates to `/chat/{coachingId}`.
- Highlight it when the current URL matches.
- Add a reset button (RotateCcw icon from lucide-react) that calls `trpc.conversation.reset.useMutation({ id: coachingId })`.
- On reset success, invalidate `conversation.get` and `conversation.listTaskThreads` queries, then call `setMessages([])` — but since sidebar doesn't own messages state, just invalidate queries. The chat page will re-fetch.
- Show a confirmation dialog before resetting: `window.confirm("Reset coaching conversation? Your memory and facts will be preserved.")`

**Section 2: Recent Tasks**
- Use `trpc.conversation.listTaskThreads.useQuery({ parentId: coachingId })` to fetch task threads.
- Display each as a link to `/chat/{taskThread.id}` with title and formatted date.
- Each task thread has a delete button (Trash2 icon) that calls `trpc.conversation.delete.useMutation`.
- Use a Separator component between the coaching section and the task threads section.
- Label the section "Recent Tasks" with SidebarGroupLabel-style text.

**Props:** Keep the same props interface: `activeChatId`, `open`, `onOpenChange`. Remove `collapsed`/`onCollapsedChange` — the main app sidebar handles collapsing.

**Mobile:** Keep the Sheet pattern for mobile (same as current) but with the new two-section content.

**Update `chat/[id]/page.tsx`:** No structural changes needed, but update the header to show "Coaching" or the task thread title based on the conversation type. Use `conv?.type` (now returned from tRPC) to determine:
- If `type === "coaching"`: show "Coaching" as the header title.
- If `type === "task"`: show the conversation title (e.g., "Contract Review: ...") as the header title, and hide the ModeToggle (task threads don't need mode switching).

**Update `app-sidebar.tsx`:** Change the "Chat" nav item href from `/chat` to stay as `/chat` (this already works since /chat does getOrCreateCoaching redirect). No change needed here.

**Styling:** Use shadcn/ui components consistent with the design system:
- `Button` with `variant="ghost"` and `size="icon"` for reset and delete buttons
- `Separator` between coaching and tasks sections
- `Badge` for unread/new task count if applicable (defer — just basic list for now)
- `Skeleton` for loading states
- `ScrollArea` for the task thread list if it grows long
  </action>
  <verify>
`cd apps/web && npx tsc --noEmit` passes.
Manual verification:
1. Navigate to /chat — lands on coaching thread.
2. Sidebar shows "Coaching" pinned at top with reset button.
3. After an agent dispatch (from prior functionality), a task thread appears under "Recent Tasks".
4. Clicking a task thread navigates to it and shows the task content.
5. Clicking reset on coaching thread clears messages (confirm dialog appears first).
6. Deleting a task thread removes it from the list.
  </verify>
  <done>
Conversation sidebar displays pinned coaching thread at top with reset button, task threads below by recency. Chat page header adapts to conversation type. /chat always navigates to coaching thread.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes in apps/web
- /chat redirects to the single coaching thread (same ID on repeated visits)
- Sidebar has two distinct sections: pinned coaching and recent tasks
- Reset button clears coaching messages (userFacts preserved)
- Task threads listed by recency with delete capability
- Mobile sidebar (Sheet) shows the same two-section layout
</verification>

<success_criteria>
Users always land on their coaching thread from the Chat nav link. Sidebar clearly separates the pinned coaching thread from task threads. Reset functionality works with confirmation. Task threads are navigable and deletable.
</success_criteria>

<output>
After completion, create `.planning/phases/05-ui-polish-styling/05-07-SUMMARY.md`
</output>
