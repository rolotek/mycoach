---
phase: 05-ui-polish-styling
plan: 07
type: execute
wave: 2
depends_on: ["05-06"]
files_modified:
  - apps/web/src/app/(app)/chat/page.tsx
  - apps/web/src/app/(app)/chat/[id]/page.tsx
  - apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx
  - apps/web/src/app/(app)/chat/components/message-list.tsx
  - apps/web/src/app/(app)/chat/components/agent-result.tsx
  - apps/web/src/hooks/use-coaching-chat.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Sidebar shows pinned Coaching thread at top with a reset button"
    - "Sidebar shows task threads below Coaching, ordered by recency, with date labels"
    - "Clicking reset clears coaching messages but coach retains memory"
    - "Agent dispatch shows compact inline summary card in coaching thread (not full result)"
    - "Inline summary card has agent name, task description, and 'View result' link to task thread"
    - "Full agent result lives in task thread page, not inline in coaching chat"
    - "Navigating to /chat lands on the coaching thread (not creates a new conversation)"
  artifacts:
    - path: "apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx"
      provides: "Pinned coaching thread + task thread list sidebar"
      contains: "Coaching"
    - path: "apps/web/src/app/(app)/chat/components/message-list.tsx"
      provides: "Inline summary card for agent dispatches"
      contains: "View result"
    - path: "apps/web/src/app/(app)/chat/page.tsx"
      provides: "Redirect to coaching thread instead of creating new conversation"
      contains: "getOrCreateCoaching"
    - path: "apps/web/src/app/(app)/chat/[id]/page.tsx"
      provides: "Chat page that works for both coaching and task threads"
      contains: "chatId"
  key_links:
    - from: "apps/web/src/app/(app)/chat/page.tsx"
      to: "tRPC conversation.getOrCreateCoaching"
      via: "trpc query to get coaching thread ID then redirect"
      pattern: "getOrCreateCoaching"
    - from: "apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx"
      to: "tRPC conversation.listTaskThreads"
      via: "trpc query for task threads"
      pattern: "listTaskThreads"
    - from: "apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx"
      to: "tRPC conversation.reset"
      via: "reset mutation on coaching thread"
      pattern: "reset"
    - from: "apps/web/src/app/(app)/chat/components/message-list.tsx"
      to: "apps/web/src/app/(app)/chat/[id]/page.tsx"
      via: "View result link navigates to /chat/[taskThreadId]"
      pattern: "View result"
---

<objective>
Rebuild the chat frontend for the hybrid coaching + task thread model: pinned coaching sidebar, task thread list, inline summary cards, reset button, and /chat redirect to coaching thread.

Purpose: Implement the user-facing conversation model per locked decisions -- single persistent coaching relationship with separate task threads for agent dispatches.

Output: Updated chat pages and components implementing the full conversation model UX.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-ui-polish-styling/05-CONTEXT.md
@.planning/phases/05-ui-polish-styling/05-06-SUMMARY.md

@apps/web/src/app/(app)/chat/page.tsx
@apps/web/src/app/(app)/chat/[id]/page.tsx
@apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx
@apps/web/src/app/(app)/chat/components/message-list.tsx
@apps/web/src/app/(app)/chat/components/agent-result.tsx
@apps/web/src/hooks/use-coaching-chat.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rebuild conversation sidebar with pinned coaching + task threads + reset</name>
  <files>
    apps/web/src/app/(app)/chat/page.tsx
    apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx
  </files>
  <action>
**chat/page.tsx (redirect to coaching thread):**

Replace the current "create new conversation on mount" behavior. Instead:
1. Use `trpc.conversation.getOrCreateCoaching.useQuery()` to get the coaching thread
2. Once data arrives, `router.replace(`/chat/${data.id}`)` to navigate to it
3. Show a loading state while the query resolves (use Skeleton or "Loading..." text)
4. This means /chat ALWAYS routes to the single coaching thread -- no more creating new conversations from this page

**conversation-sidebar.tsx (complete rebuild):**

Replace the current flat conversation list with the locked sidebar layout:

```
Coaching (pinned)           [reset]
-------------------------------
Recent Tasks
  Contract Review            Feb 14
  Meeting Prep               Feb 13
  Email Draft                Feb 12
```

Implementation:
1. Use `trpc.conversation.getOrCreateCoaching.useQuery()` to get the coaching thread (for the pinned item and to know the parentId for task threads)
2. Use `trpc.conversation.listTaskThreads.useQuery({ parentId: coachingThread?.id })` to get task threads (enabled only when coaching thread ID is available)
3. **Pinned coaching section:**
   - Always at top, not scrollable with task list
   - Shows "Coaching" label with a MessageSquare icon
   - Active state when `activeChatId === coachingThread.id`
   - Reset button (RotateCcw icon from lucide-react) at the right side
   - Reset button calls `trpc.conversation.reset.useMutation()` with the coaching thread ID
   - On reset success: invalidate `conversation.getOrCreateCoaching` and `conversation.get` queries, then call a passed-in `onResetMessages` callback (or alternatively, the page can react to the query invalidation)
   - Confirm before reset: `window.confirm("Reset coaching conversation? Your coach will still remember everything about you.")`
4. **Separator line** between coaching and task threads (use shadcn Separator component)
5. **Task threads section:**
   - Label: "Recent Tasks" (text-xs text-muted-foreground, uppercase tracking)
   - List of task threads ordered by recency (from listTaskThreads query)
   - Each item shows: title (truncated) and date (formatted like "Feb 14")
   - Active state when `activeChatId === thread.id`
   - Clicking navigates to `/chat/${thread.id}`
   - Delete button (X icon, ghost) on hover -- calls `conversation.delete` mutation
   - If no task threads, show "No tasks yet" in muted text
6. Keep the mobile Sheet behavior (Sheet on mobile, fixed panel on desktop) from current implementation
7. Remove the "New Chat" button (no longer needed -- coaching thread is the entry point)

Date formatting for task threads: show "Feb 14" style (month abbreviated + day number).
  </action>
  <verify>
    cd /Users/allenwong/Workspace/mycoach && npx tsc --noEmit -p apps/web/tsconfig.json
  </verify>
  <done>
    - /chat redirects to the coaching thread (no new conversation creation)
    - Sidebar shows pinned "Coaching" at top with reset button
    - Sidebar shows task threads below separator ordered by recency
    - Reset button clears coaching messages after confirmation
    - Mobile Sheet and desktop panel both work
    - No "New Chat" button
  </done>
</task>

<task type="auto">
  <name>Task 2: Inline summary cards in coaching thread + task thread view</name>
  <files>
    apps/web/src/app/(app)/chat/components/message-list.tsx
    apps/web/src/app/(app)/chat/components/agent-result.tsx
    apps/web/src/app/(app)/chat/[id]/page.tsx
    apps/web/src/hooks/use-coaching-chat.ts
  </files>
  <action>
**agent-result.tsx (add compact inline summary card):**

Add a new exported component `AgentDispatchSummaryCard`:
```typescript
export function AgentDispatchSummaryCard({
  agentName,
  task,
  taskThreadId,
}: {
  agentName: string;
  task: string;
  taskThreadId?: string;
}) {
  // Compact card that appears inline in the coaching thread
  // - Left accent border (border-l-4 border-l-primary)
  // - Agent name as Badge
  // - Task description (truncated to ~100 chars)
  // - "View result ->" link that navigates to /chat/${taskThreadId}
  // - If no taskThreadId, show "Processing..." instead of link
}
```

Styling: smaller than AgentResultCard. Think notification card -- 2-3 lines max. Uses Card component with compact padding (px-3 py-2). The "View result" link uses Next.js Link component with `text-primary hover:underline text-sm` styling.

Keep the existing `AgentResultCard` component -- it will be used when viewing a task thread directly (the full result display).

Keep the existing `FeedbackButtons` component -- it stays on the AgentResultCard in the task thread view.

**message-list.tsx changes:**

When rendering agent dispatch parts in the coaching thread:
1. For `state === "output-available"` parts: render `AgentDispatchSummaryCard` instead of `AgentResultCard`
   - Pass `agentName`, `task` (from part.input?.task), and `taskThreadId` (from part.output?.taskThreadId)
   - This shows the compact "View result" card, NOT the full agent output
2. For `state === "approval-requested"`: keep showing `AgentApprovalCard` as-is
3. For `state === "output-denied"`: keep showing `AgentDeniedCard` as-is
4. For `state === "call"` / `state === "input-available"`: keep the "Routing to..." spinner

The key change is: completed agent dispatches in coaching thread show a compact summary with a link, not the full result.

**chat/[id]/page.tsx changes:**

1. Use `trpc.conversation.get.useQuery({ id: chatId })` to determine if this is a coaching thread or task thread (check `conv.type`)
2. If coaching thread: render the normal chat interface with message input, mode toggle, and coaching sidebar
3. If task thread: render a read-only view:
   - Header shows task thread title and a "Back to Coaching" link (navigate to coaching thread)
   - Message list shows the full agent result (using existing AgentResultCard with feedback buttons)
   - No chat input (task threads are read-only for now -- the agent result is the content)
   - The conversation sidebar still shows (with the task thread highlighted as active)
4. Use the `conv.type` field from the get query response to determine render mode

**use-coaching-chat.ts:**

No changes needed unless the task thread rendering requires it. The hook is only used for the coaching thread chat; task threads are displayed as read-only content from the conversation.get query data.
  </action>
  <verify>
    cd /Users/allenwong/Workspace/mycoach && npx tsc --noEmit -p apps/web/tsconfig.json
  </verify>
  <done>
    - Agent dispatch in coaching thread shows compact summary card with "View result" link
    - "View result" link navigates to /chat/[taskThreadId]
    - Task thread page shows full agent result with feedback buttons (read-only, no input)
    - Task thread page has "Back to Coaching" navigation
    - Coaching thread page has chat input and mode toggle
    - TypeScript compiles without errors
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit -p apps/web/tsconfig.json` passes
2. /chat redirects to coaching thread
3. Sidebar displays pinned coaching + task threads per locked decision layout
4. Reset button clears messages and coaching thread remains functional
5. Agent dispatch results appear as compact inline cards in coaching thread
6. Clicking "View result" navigates to task thread with full result
7. Task thread page is read-only with back navigation
</verification>

<success_criteria>
- Sidebar matches locked decision layout: pinned Coaching with reset, separator, Recent Tasks by recency
- /chat always lands on coaching thread
- Agent dispatches produce inline summary cards (not full results) in coaching chat
- Task threads accessible via "View result" link
- Task thread shows full agent result and feedback buttons
- All TypeScript compilation passes
</success_criteria>

<output>
After completion, create `.planning/phases/05-ui-polish-styling/05-07-SUMMARY.md`
</output>
