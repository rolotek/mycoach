---
phase: 05-ui-polish-styling
plan: 07
type: execute
wave: 2
depends_on: ["05-06"]
files_modified:
  - apps/web/src/app/(app)/chat/page.tsx
  - apps/web/src/app/(app)/chat/[id]/page.tsx
  - apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx
  - apps/web/src/app/(app)/chat/components/agent-result.tsx
  - apps/web/src/app/(app)/chat/components/message-list.tsx
autonomous: true

must_haves:
  truths:
    - "Coaching thread is always pinned at top of the conversation sidebar with a reset button"
    - "Task threads appear below coaching thread grouped under 'Recent Tasks' by recency"
    - "Clicking reset clears coaching messages but keeps the conversation; memory/userFacts persist"
    - "When agent dispatch is approved, an inline summary card appears in coaching thread with agent name, task, and 'View result' link"
    - "The 'View result' link navigates to the task thread where the full agent output lives"
    - "Task threads are independently deletable/archivable from the sidebar"
    - "Navigating to /chat redirects to the coaching thread (not creates a new conversation)"
  artifacts:
    - path: "apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx"
      provides: "Pinned coaching section + task thread list with reset button"
      contains: "Coaching"
    - path: "apps/web/src/app/(app)/chat/page.tsx"
      provides: "Redirect to coaching thread via getOrCreateCoaching"
      contains: "getOrCreateCoaching"
    - path: "apps/web/src/app/(app)/chat/components/agent-result.tsx"
      provides: "Compact inline summary card with View result link for coaching thread"
      contains: "View result"
    - path: "apps/web/src/app/(app)/chat/[id]/page.tsx"
      provides: "Chat page that works for both coaching and task thread views"
      contains: "type"
  key_links:
    - from: "apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx"
      to: "conversation.list tRPC"
      via: "Groups conversations by type field"
      pattern: "type.*coaching"
    - from: "apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx"
      to: "conversation.reset tRPC"
      via: "Reset button calls reset mutation"
      pattern: "reset"
    - from: "apps/web/src/app/(app)/chat/components/agent-result.tsx"
      to: "apps/web/src/app/(app)/chat/[id]/page.tsx"
      via: "View result link navigates to /chat/{taskConversationId}"
      pattern: "View result"
---

<objective>
Rewrite the chat frontend for the hybrid coaching + task thread model: pinned coaching sidebar, task thread list, reset button, inline agent summary cards with "View result" links, and redirect /chat to the coaching thread.

Purpose: Implements the three locked decisions -- (1) hybrid coaching + task threads, (2) inline summary + task thread for agent results, (3) sidebar layout with pinned coaching. This transforms the flat conversation list into the target UX.

Output: Reworked conversation sidebar, chat page, agent result cards, and /chat redirect.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-ui-polish-styling/05-06-SUMMARY.md
@apps/web/src/app/(app)/chat/page.tsx
@apps/web/src/app/(app)/chat/[id]/page.tsx
@apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx
@apps/web/src/app/(app)/chat/components/agent-result.tsx
@apps/web/src/app/(app)/chat/components/message-list.tsx
@apps/web/src/hooks/use-coaching-chat.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Rewrite conversation sidebar with pinned coaching + task threads + reset</name>
  <files>apps/web/src/app/(app)/chat/components/conversation-sidebar.tsx, apps/web/src/app/(app)/chat/page.tsx</files>
  <action>
**Rewrite `conversation-sidebar.tsx`:**

Replace the current flat conversation list with the locked sidebar layout:

```
Coaching (pinned)           [reset]
───────────────────────────
Recent Tasks
  Contract Review            Feb 14
  Meeting Prep               Feb 13
  Email Draft                Feb 12
```

Implementation details:

1. Query `trpc.conversation.list` (which now returns `type` and `parentId`).

2. Separate conversations into two groups:
   - `coachingConv`: The single conversation where `type === "coaching"` (there should be exactly one; take the first)
   - `taskConvs`: All conversations where `type === "task"`, sorted by updatedAt descending

3. **Coaching section (pinned at top):**
   - Always visible, not scrollable away
   - Shows "Coaching" label on the left
   - Shows a reset button (RotateCcw icon from lucide-react) on the right
   - The entire row is a Link to `/chat/{coachingConv.id}`
   - Active state: highlight with `bg-accent` when `activeChatId === coachingConv.id`
   - Reset button: onClick calls `trpc.conversation.reset.useMutation()` with the coaching conversation id. After success, invalidate `conversation.list` and `conversation.get`. Show `window.confirm("Reset coaching conversation? Your memory and facts will be preserved.")` before proceeding.

4. **Separator:** A `<Separator />` (from shadcn/ui) between coaching and tasks sections.

5. **Task threads section:**
   - Label: "Recent Tasks" (text-xs font-medium text-muted-foreground, uppercase tracking)
   - Each task thread: shows title on left, formatted date on right (use the existing `formatDate` helper)
   - Each task thread row is a Link to `/chat/{taskConv.id}`
   - Active state: highlight when `activeChatId === taskConv.id`
   - Delete button: ghost button with X icon, visible on hover (group/opacity pattern). Calls existing `trpc.conversation.delete.useMutation()`. Only on task threads (coaching thread uses reset, not delete).
   - This section scrolls if there are many tasks (`overflow-y-auto flex-1`)

6. **No "New Chat" button.** The coaching thread is always present. New task threads are created automatically by agent dispatches. Remove the existing "New Chat" button.

7. Keep the existing desktop/mobile responsive pattern (desktop: side panel; mobile: Sheet).

**Rewrite `chat/page.tsx` (the /chat redirect):**

Replace the current behavior (creates a new conversation, then redirects) with:
```typescript
"use client";

import { useEffect } from "react";
import { useRouter } from "next/navigation";
import { trpc } from "@/lib/trpc";

export default function ChatPage() {
  const router = useRouter();
  const getOrCreate = trpc.conversation.getOrCreateCoaching.useMutation({
    onSuccess: (data) => {
      router.replace(`/chat/${data.id}`);
    },
  });

  useEffect(() => {
    getOrCreate.mutate();
  }, []);

  return (
    <div className="flex min-h-screen items-center justify-center bg-background">
      <p className="text-muted-foreground">Loading coaching session...</p>
    </div>
  );
}
```

This ensures /chat always goes to the single coaching thread instead of creating new conversations.
  </action>
  <verify>
Run `npx tsc --noEmit` from apps/web -- no type errors.
Navigate to /chat in browser -- should redirect to the coaching thread.
Sidebar shows "Coaching" pinned at top with reset button, task threads below.
  </verify>
  <done>
- Conversation sidebar has pinned coaching thread at top with reset button
- Task threads listed below under "Recent Tasks" by recency
- Task threads are deletable; coaching thread uses reset (not delete)
- /chat redirects to the coaching conversation (getOrCreateCoaching)
- No "New Chat" button; coaching thread is persistent, task threads are auto-created
  </done>
</task>

<task type="auto">
  <name>Task 2: Inline summary cards in coaching thread + task thread view</name>
  <files>apps/web/src/app/(app)/chat/components/agent-result.tsx, apps/web/src/app/(app)/chat/components/message-list.tsx, apps/web/src/app/(app)/chat/[id]/page.tsx</files>
  <action>
**Update `agent-result.tsx`:**

1. Keep `FeedbackButtons` as-is (used in task thread view).

2. Add a new `AgentDispatchSummaryCard` component for inline display in the coaching thread:
```typescript
import Link from "next/link";
import { ExternalLink } from "lucide-react";

export function AgentDispatchSummaryCard({
  agentName,
  task,
  taskConversationId,
}: {
  agentName: string;
  task: string;
  taskConversationId?: string;
}) {
  return (
    <div className="rounded-lg border border-border bg-card px-4 py-3 shadow-sm">
      <div className="flex items-center justify-between gap-2">
        <div className="flex items-center gap-2">
          <Badge variant="secondary">{agentName}</Badge>
          <span className="text-sm text-muted-foreground truncate">{task}</span>
        </div>
        {taskConversationId && (
          <Link
            href={`/chat/${taskConversationId}`}
            className="inline-flex items-center gap-1 text-sm font-medium text-primary hover:underline whitespace-nowrap"
          >
            View result
            <ExternalLink className="h-3 w-3" />
          </Link>
        )}
      </div>
    </div>
  );
}
```

3. Keep the existing `AgentResultCard` component (with full markdown result + feedback buttons) -- this will be used when viewing a task thread directly.

**Update `message-list.tsx`:**

Add a `conversationType` prop to `MessageList` (default: "coaching"). When rendering dispatch parts with `state === "output-available"`:

- If `conversationType === "coaching"`: render `AgentDispatchSummaryCard` instead of `AgentResultCard`. Pass `agentName`, `task` from the input, and `taskConversationId` from the output.
- If `conversationType === "task"`: render `AgentResultCard` as before (full result with feedback buttons).

Update the `MessageListMessage` type's output to include `taskConversationId?: string`.

The import at the top should add:
```typescript
import { AgentResultCard, AgentDeniedCard, AgentDispatchSummaryCard } from "./agent-result";
```

In the dispatch parts rendering section, replace the `output-available` case:
```typescript
if (part.state === "output-available" && part.output) {
  const out = part.output;
  if (conversationType === "coaching") {
    return (
      <div key={`${m.id}-${i}`} className="max-w-[85%]">
        <AgentDispatchSummaryCard
          agentName={out.agentName ?? agentName}
          task={part.input?.task ?? ""}
          taskConversationId={out.taskConversationId}
        />
      </div>
    );
  }
  // Task thread: show full result
  const result = typeof out.result === "string" ? out.result : String(out.result ?? "");
  const name = out.agentName ?? agentName;
  return (
    <div key={`${m.id}-${i}`} className="max-w-[85%]">
      <AgentResultCard
        agentName={name}
        result={result}
        executionId={out.executionId}
        agentId={out.agentId}
      />
    </div>
  );
}
```

**Update `chat/[id]/page.tsx`:**

1. The page already queries `trpc.conversation.get` which returns the full conversation. Now the response includes `type`. Pass `conversationType={conv?.type ?? "coaching"}` to `MessageList`.

2. For task threads (conv.type === "task"), adjust the header to show the task thread title instead of just "Coach":
```typescript
<h1 className="text-lg font-medium text-foreground">
  {conv?.type === "task" ? (conv.title ?? "Task") : "Coach"}
</h1>
```

3. For task threads, hide the ModeToggle (mode switching only makes sense for coaching). Show it only when `conv?.type === "coaching"` or when conv is not loaded yet.

4. The chat input placeholder should be contextual:
- Coaching: "Message your coach..."
- Task: "Follow up on this task..." (task threads allow follow-up questions)
  </action>
  <verify>
Run `npx tsc --noEmit` from apps/web -- no type errors.
In coaching thread, agent dispatch results show as compact summary cards with "View result" link.
In task thread, full agent output with feedback buttons is shown.
Task thread header shows the task title, not "Coach".
  </verify>
  <done>
- Coaching thread shows compact AgentDispatchSummaryCard (agent name, task, "View result" link)
- Clicking "View result" navigates to the task thread with full output
- Task thread shows full AgentResultCard with markdown and feedback buttons
- Task thread header shows task title; coaching thread shows "Coach"
- Mode toggle only appears on coaching threads
- Chat input placeholder is contextual
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes in apps/web
2. /chat redirects to coaching thread
3. Sidebar shows pinned coaching + task threads grouped separately
4. Reset button clears coaching messages
5. Agent dispatch in coaching thread creates inline summary card
6. "View result" link navigates to task thread with full output
7. Build succeeds: `npm run build` from monorepo root
</verification>

<success_criteria>
- Coaching thread pinned at top of sidebar with reset button (per locked decision 1 and 3)
- Task threads listed under "Recent Tasks" by recency (per locked decision 3)
- Agent dispatch shows compact inline summary + "View result" link in coaching thread (per locked decision 2)
- Full agent output lives in its own task thread (per locked decision 2)
- /chat navigates to the single coaching thread, not a new conversation
- Task threads are deletable; coaching thread uses reset only
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-ui-polish-styling/05-07-SUMMARY.md`
</output>
