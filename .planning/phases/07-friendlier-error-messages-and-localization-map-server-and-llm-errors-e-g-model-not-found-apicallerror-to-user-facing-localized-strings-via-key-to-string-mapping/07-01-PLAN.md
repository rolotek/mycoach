---
phase: 07-friendlier-errors-and-i18n
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/web/package.json
  - apps/web/next.config.ts
  - apps/web/src/i18n/routing.ts
  - apps/web/src/i18n/request.ts
  - apps/web/src/i18n/navigation.ts
  - apps/web/middleware.ts
  - apps/web/src/app/layout.tsx
  - apps/web/src/app/[locale]/layout.tsx
  - apps/web/src/components/locale-toggle.tsx
  - apps/web/src/components/app-sidebar.tsx
autonomous: true

must_haves:
  truths:
    - "next-intl is installed and configured for Next.js App Router"
    - "Supported locales: en (default), fr-FR, it, ja, zh-CN, en-GB"
    - "Locale is detected from system (Accept-Language) by default; user can override via persisted preference (cookie), same pattern as dark/light theme"
    - "Locale is available via [locale] segment or provider; middleware sets locale"
    - "Messages loaded from JSON per locale; en.json exists as default"
    - "User can override locale via a locale switcher (e.g. Settings and/or header) that persists choice in NEXT_LOCALE cookie; 'System' option clears override so system language is used"
  artifacts:
    - path: "apps/web/src/i18n/routing.ts"
      provides: "Locale list and default locale"
    - path: "apps/web/src/i18n/request.ts"
      provides: "getRequestConfig for server-side messages"
    - path: "apps/web/middleware.ts"
      provides: "Locale detection and routing"
    - path: "apps/web/messages/en.json"
      provides: "Default English message keys (can be minimal initially)"
    - path: "apps/web/src/components/locale-toggle.tsx"
      provides: "Locale switcher (System + per-locale options), persists via NEXT_LOCALE cookie"
---

<objective>
Add i18n foundation with next-intl: install package, configure locales (en, fr-FR, it, ja, zh-CN, en-GB) with en as default, set up routing/request config and middleware so all app routes run under a locale and messages are loadable. Locale behavior must mirror theme: default from system (Accept-Language), with user override persisted (e.g. NEXT_LOCALE cookie) and a locale switcher UI (System / English / Français / etc.) so users can choose "System" or a specific language.

Purpose: Phase 7 localization depends on this. Without it, string extraction and error mapping cannot be wired to locale.
Output: next-intl wired; app structure uses [locale]; middleware uses system locale by default and respects user override via cookie; LocaleToggle component (like ThemeToggle) for System + locale options; messages/en.json present.
</objective>

<execution_context>
@./.cursor/get-shit-done/workflows/execute-plan.md
@./.cursor/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@apps/web/package.json
@apps/web/next.config.ts
@apps/web/src/app/layout.tsx
@apps/web/src/app/(app)/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install next-intl and add i18n config files</name>
  <files>apps/web/package.json, apps/web/src/i18n/routing.ts, apps/web/src/i18n/request.ts, apps/web/src/i18n/navigation.ts</files>
  <action>
1. In apps/web: `npm install next-intl`

2. Create `apps/web/src/i18n/routing.ts`:
   - Export `locales`: ['en', 'fr-FR', 'it', 'ja', 'zh-CN', 'en-GB']
   - Export `defaultLocale`: 'en'
   - Use defineRouting from 'next-intl/routing' if available, or export plain constants

3. Create `apps/web/src/i18n/request.ts`:
   - Import getRequestConfig from 'next-intl/server'
   - Import routing from './routing'
   - Export default getRequestConfig(async ({ requestLocale }) => { ... }) that:
     - Resolves locale from requestLocale or routing.defaultLocale
     - Validates against routing.locales; fallback to defaultLocale
     - Loads messages: await import(`../messages/${locale}.json`) or require
     - Returns { locale, messages, timeZone }

4. Create `apps/web/src/i18n/navigation.ts`:
   - Export createNavigation from 'next-intl/navigation' with Link, useRouter, usePathname using routing config (or document that routing is in middleware)
</action>
  <verify>
Build apps/web: `cd apps/web && npm run build` — must succeed. Imports from next-intl resolve.
</verify>
</task>

<task type="auto">
  <name>Task 2: Add middleware and [locale] layout; move routes under [locale]</name>
  <files>apps/web/middleware.ts, apps/web/src/app/layout.tsx, apps/web/src/app/[locale]/layout.tsx, apps/web/next.config.ts</files>
  <action>
1. Create or update `apps/web/middleware.ts`:
   - Use createMiddleware from 'next-intl/middleware' with routing (locales, defaultLocale)
   - Rely on next-intl default locale detection: Accept-Language (system) when no cookie; NEXT_LOCALE cookie for user override (same idea as theme: system by default, user can override)
   - Matcher: apply to all pathnames except static files and api

2. Update `apps/web/next.config.ts` (or next.config.js):
   - Add withNextIntl plugin from 'next-intl/plugin' with i18n request config path: './src/i18n/request.ts' (or as per next-intl docs)

3. Restructure app so that (app) and (auth) and any other route groups live under [locale]:
   - Create `apps/web/src/app/[locale]/layout.tsx` that:
     - Receives { children, params } (params.locale)
     - Renders NextIntlClientProvider with locale and messages (getMessages from next-intl/server or pass from layout)
     - Renders { children }
   - Move `(app)` and `(auth)` and root `page.tsx` under `[locale]`: i.e. `app/[locale]/(app)/...`, `app/[locale]/(auth)/...`, `app/[locale]/page.tsx`
   - Keep root `app/layout.tsx` minimal: html/body and global providers (Theme, Tooltip) only; no locale-specific content. Redirect or delegate to [locale] if needed per next-intl pattern.

   If next-intl docs prefer root layout to wrap with NextIntlClientProvider and no [locale] in path, then use that pattern instead: single locale from cookie/header, no URL segment. Prefer [locale] in path so we can support en-GB vs en and explicit locale switching.

4. Ensure default redirect: visiting / should redirect to /en (or defaultLocale).
</action>
  <verify>
Run `cd apps/web && npm run build`. No broken routes. Home and one app route load in dev.
</verify>
</task>

<task type="auto">
  <name>Task 3: Create default messages file and wire providers</name>
  <files>apps/web/messages/en.json, apps/web/src/app/[locale]/layout.tsx</files>
  <action>
1. Create `apps/web/messages/en.json` with a minimal set of keys so the app still works:
   - e.g. { "common": { "loading": "Loading..." }, "auth": {}, "chat": {}, "settings": {} }
   - Or copy a few keys from existing UI strings to be replaced in 07-02.

2. In [locale] layout: ensure getMessages() is called (server) and passed to NextIntlClientProvider so client components can use useTranslations().
</action>
  <verify>
Build passes; opening /en (or default locale) shows app without runtime errors for missing messages.
</verify>
</task>

<task type="auto">
  <name>Task 4: Locale switcher (system + user override), like ThemeToggle</name>
  <files>apps/web/src/components/locale-toggle.tsx, apps/web/src/app/[locale]/(app)/layout.tsx or app-sidebar</files>
  <action>
1. Add a locale switcher component (same UX pattern as theme: system default, user override):
   - Create `apps/web/src/components/locale-toggle.tsx` (or `locale-switcher.tsx`):
     - Options: "System" (use browser/OS language), then one entry per supported locale: English, Français (fr-FR), Italiano, 日本語, 简体中文, British English (en-GB).
     - On select: set NEXT_LOCALE cookie to the chosen locale (or clear cookie for "System") and navigate to the same path under the new locale (e.g. useRouter from next-intl navigation) so the page reloads in that locale.
     - Use a dropdown or select UI similar to ThemeToggle (dropdown with menu items). Show current locale or "System" in the trigger.
   - Document: next-intl middleware already reads NEXT_LOCALE; when cookie is absent, it uses Accept-Language (system). So "System" = clear NEXT_LOCALE cookie and redirect to path without cookie so middleware re-detects.

2. Place the locale switcher where theme is available (e.g. header next to ThemeToggle in app layout, or in Settings page). Add it to the app header/sidebar next to ThemeToggle so users can change language like they change theme.
</action>
  <verify>
Selecting a locale updates the UI language and persists on refresh; selecting "System" clears override and uses browser language.
</verify>
</task>

</tasks>

After completion, create `.planning/phases/07-friendlier-error-messages-and-localization-map-server-and-llm-errors-e-g-model-not-found-apicallerror-to-user-facing-localized-strings-via-key-to-string-mapping/07-01-SUMMARY.md`
